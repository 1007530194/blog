<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!-->
<html class="no-js" lang="en"><!--<![endif]-->
    <head>
<meta charset="utf-8">
<title>spark-en汇总 &mdash; 魑魅魍魉</title>

<meta name="author" content="niult">






<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">



<link href="../../../theme/css/main.css" media="screen, projection"
      rel="stylesheet" type="text/css">

<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
      rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
      rel="stylesheet" type="text/css">
</head>

<body>

<script src="../../../theme/js/modernizr-2.0.js"></script>
<script src="../../../theme/js/ender.js"></script>
<script src="../../../theme/js/octopress.js" type="text/javascript"></script>
<script src="../../../theme/js/echarts.min.js" type="text/javascript"></script>
<script src="../../../theme/js/require.min.js" type="text/javascript"></script>

<header role="banner"><hgroup>
  <h1><a href="../../../">魑魅魍魉</a></h1>
</hgroup></header>
<nav role="navigation">    <ul class="subscription" data-subscription="rss">
    </ul>


<ul class="main-navigation">
            <li >
                <a href="../../../category/01chang yong gong ju.html">01常用工具</a>
            </li>
            <li >
                <a href="../../../category/02.wo ai du shu.html">02.我爱读书</a>
            </li>
            <li >
                <a href="../../../category/algorithms.html">Algorithms</a>
            </li>
            <li >
                <a href="../../../category/book.html">Book</a>
            </li>
            <li >
                <a href="../../../category/book-pydata.html">Book-pydata</a>
            </li>
            <li >
                <a href="../../../category/deep-learning-with-python.html">Deep-learning-with-python</a>
            </li>
            <li >
                <a href="../../../category/ji qi xue xi shi zhan.html">机器学习实战</a>
            </li>
            <li >
                <a href="../../../category/ke wai du wu.html">课外读物</a>
            </li>
            <li >
                <a href="../../../category/ling ji chu ru men shen du xue xi.html">零基础入门深度学习</a>
            </li>
            <li >
                <a href="../../../category/shen du xue xi.html">深度学习</a>
            </li>
            <li >
                <a href="../../../category/shen jing wang luo.html">神经网络</a>
            </li>
            <li >
                <a href="../../../category/shu ju wa jue.html">数据挖掘</a>
            </li>
            <li >
                <a href="../../../category/shu xue ji chu.html">数学基础</a>
            </li>
            <li >
                <a href="../../../category/tf-example.html">Tf-example</a>
            </li>
            <li >
                <a href="../../../category/tool1.html">Tool1</a>
            </li>
            <li >
                <a href="../../../category/tool2.html">Tool2</a>
            </li>
            <li class="active">
                <a href="../../../category/tools.html">Tools</a>
            </li>
            <li >
                <a href="../../../category/tui jian xi tong.html">推荐系统</a>
            </li>
            <li >
                <a href="../../../category/wen ben wa jue.html">文本挖掘</a>
            </li>
</ul>
</nav>
<div id="main">
    <div id="content">
    <div>

        <h4>Contents</h4>
        

        <article class="hentry" role="article">
<header>
        <h1 class="entry-title">spark-en汇总</h1>
    <p class="meta">
<time datetime="2019-01-15T00:00:00+08:00" pubdate>2019-01-15 00:00</time>    </p>
</header>

    <div class="entry-content"><style type="text/css">/*!
*
* IPython notebook
*
*/
/* CSS font colors for translated ANSI colors. */
.ansibold {
  font-weight: bold;
}
/* use dark versions for foreground, to improve visibility */
.ansiblack {
  color: black;
}
.ansired {
  color: darkred;
}
.ansigreen {
  color: darkgreen;
}
.ansiyellow {
  color: #c4a000;
}
.ansiblue {
  color: darkblue;
}
.ansipurple {
  color: darkviolet;
}
.ansicyan {
  color: steelblue;
}
.ansigray {
  color: gray;
}
/* and light for background, for the same reason */
.ansibgblack {
  background-color: black;
}
.ansibgred {
  background-color: red;
}
.ansibggreen {
  background-color: green;
}
.ansibgyellow {
  background-color: yellow;
}
.ansibgblue {
  background-color: blue;
}
.ansibgpurple {
  background-color: magenta;
}
.ansibgcyan {
  background-color: cyan;
}
.ansibggray {
  background-color: gray;
}
div.cell {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  border-radius: 2px;
  box-sizing: border-box;
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
  border-width: 1px;
  border-style: solid;
  border-color: transparent;
  width: 100%;
  padding: 5px;
  /* This acts as a spacer between cells, that is outside the border */
  margin: 0px;
  outline: none;
  border-left-width: 1px;
  padding-left: 5px;
  background: linear-gradient(to right, transparent -40px, transparent 1px, transparent 1px, transparent 100%);
}
div.cell.jupyter-soft-selected {
  border-left-color: #90CAF9;
  border-left-color: #E3F2FD;
  border-left-width: 1px;
  padding-left: 5px;
  border-right-color: #E3F2FD;
  border-right-width: 1px;
  background: #E3F2FD;
}
@media print {
  div.cell.jupyter-soft-selected {
    border-color: transparent;
  }
}
div.cell.selected {
  border-color: #ababab;
  border-left-width: 0px;
  padding-left: 6px;
  background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 5px, transparent 5px, transparent 100%);
}
@media print {
  div.cell.selected {
    border-color: transparent;
  }
}
div.cell.selected.jupyter-soft-selected {
  border-left-width: 0;
  padding-left: 6px;
  background: linear-gradient(to right, #42A5F5 -40px, #42A5F5 7px, #E3F2FD 7px, #E3F2FD 100%);
}
.edit_mode div.cell.selected {
  border-color: #66BB6A;
  border-left-width: 0px;
  padding-left: 6px;
  background: linear-gradient(to right, #66BB6A -40px, #66BB6A 5px, transparent 5px, transparent 100%);
}
@media print {
  .edit_mode div.cell.selected {
    border-color: transparent;
  }
}
.prompt {
  /* This needs to be wide enough for 3 digit prompt numbers: In[100]: */
  min-width: 14ex;
  /* This padding is tuned to match the padding on the CodeMirror editor. */
  padding: 0.4em;
  margin: 0px;
  font-family: monospace;
  text-align: right;
  /* This has to match that of the the CodeMirror class line-height below */
  line-height: 1.21429em;
  /* Don't highlight prompt number selection */
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  /* Use default cursor */
  cursor: default;
}
@media (max-width: 540px) {
  .prompt {
    text-align: left;
  }
}
div.inner_cell {
  min-width: 0;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  /* Old browsers */
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  box-flex: 1;
  /* Modern browsers */
  flex: 1;
}
/* input_area and input_prompt must match in top border and margin for alignment */
div.input_area {
  border: 1px solid #cfcfcf;
  border-radius: 2px;
  background: #f7f7f7;
  line-height: 1.21429em;
}
/* This is needed so that empty prompt areas can collapse to zero height when there
   is no content in the output_subarea and the prompt. The main purpose of this is
   to make sure that empty JavaScript output_subareas have no height. */
div.prompt:empty {
  padding-top: 0;
  padding-bottom: 0;
}
div.unrecognized_cell {
  padding: 5px 5px 5px 0px;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
div.unrecognized_cell .inner_cell {
  border-radius: 2px;
  padding: 5px;
  font-weight: bold;
  color: red;
  border: 1px solid #cfcfcf;
  background: #eaeaea;
}
div.unrecognized_cell .inner_cell a {
  color: inherit;
  text-decoration: none;
}
div.unrecognized_cell .inner_cell a:hover {
  color: inherit;
  text-decoration: none;
}
@media (max-width: 540px) {
  div.unrecognized_cell > div.prompt {
    display: none;
  }
}
div.code_cell {
  /* avoid page breaking on code cells when printing */
}
@media print {
  div.code_cell {
    page-break-inside: avoid;
  }
}
/* any special styling for code cells that are currently running goes here */
div.input {
  page-break-inside: avoid;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.input {
    /* Old browsers */
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-box-align: stretch;
    display: -moz-box;
    -moz-box-orient: vertical;
    -moz-box-align: stretch;
    display: box;
    box-orient: vertical;
    box-align: stretch;
    /* Modern browsers */
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
}
/* input_area and input_prompt must match in top border and margin for alignment */
div.input_prompt {
  color: #303F9F;
  border-top: 1px solid transparent;
}
div.input_area > div.highlight {
  margin: 0.4em;
  border: none;
  padding: 0px;
  background-color: transparent;
}
div.input_area > div.highlight > pre {
  margin: 0px;
  border: none;
  padding: 0px;
  background-color: transparent;
}
/* The following gets added to the <head> if it is detected that the user has a
 * monospace font with inconsistent normal/bold/italic height.  See
 * notebookmain.js.  Such fonts will have keywords vertically offset with
 * respect to the rest of the text.  The user should select a better font.
 * See: https://github.com/ipython/ipython/issues/1503
 *
 * .CodeMirror span {
 *      vertical-align: bottom;
 * }
 */
.CodeMirror {
  line-height: 1.21429em;
  /* Changed from 1em to our global default */
  font-size: 14px;
  height: auto;
  /* Changed to auto to autogrow */
  background: none;
  /* Changed from white to allow our bg to show through */
}
.CodeMirror-scroll {
  /*  The CodeMirror docs are a bit fuzzy on if overflow-y should be hidden or visible.*/
  /*  We have found that if it is visible, vertical scrollbars appear with font size changes.*/
  overflow-y: hidden;
  overflow-x: auto;
}
.CodeMirror-lines {
  /* In CM2, this used to be 0.4em, but in CM3 it went to 4px. We need the em value because */
  /* we have set a different line-height and want this to scale with that. */
  padding: 0.4em;
}
.CodeMirror-linenumber {
  padding: 0 8px 0 4px;
}
.CodeMirror-gutters {
  border-bottom-left-radius: 2px;
  border-top-left-radius: 2px;
}
.CodeMirror pre {
  /* In CM3 this went to 4px from 0 in CM2. We need the 0 value because of how we size */
  /* .CodeMirror-lines */
  padding: 0;
  border: 0;
  border-radius: 0;
}
/*

Original style from softwaremaniacs.org (c) Ivan Sagalaev <Maniac@SoftwareManiacs.Org>
Adapted from GitHub theme

*/
.highlight-base {
  color: #000;
}
.highlight-variable {
  color: #000;
}
.highlight-variable-2 {
  color: #1a1a1a;
}
.highlight-variable-3 {
  color: #333333;
}
.highlight-string {
  color: #BA2121;
}
.highlight-comment {
  color: #408080;
  font-style: italic;
}
.highlight-number {
  color: #080;
}
.highlight-atom {
  color: #88F;
}
.highlight-keyword {
  color: #008000;
  font-weight: bold;
}
.highlight-builtin {
  color: #008000;
}
.highlight-error {
  color: #f00;
}
.highlight-operator {
  color: #AA22FF;
  font-weight: bold;
}
.highlight-meta {
  color: #AA22FF;
}
/* previously not defined, copying from default codemirror */
.highlight-def {
  color: #00f;
}
.highlight-string-2 {
  color: #f50;
}
.highlight-qualifier {
  color: #555;
}
.highlight-bracket {
  color: #997;
}
.highlight-tag {
  color: #170;
}
.highlight-attribute {
  color: #00c;
}
.highlight-header {
  color: blue;
}
.highlight-quote {
  color: #090;
}
.highlight-link {
  color: #00c;
}
/* apply the same style to codemirror */
.cm-s-ipython span.cm-keyword {
  color: #008000;
  font-weight: bold;
}
.cm-s-ipython span.cm-atom {
  color: #88F;
}
.cm-s-ipython span.cm-number {
  color: #080;
}
.cm-s-ipython span.cm-def {
  color: #00f;
}
.cm-s-ipython span.cm-variable {
  color: #000;
}
.cm-s-ipython span.cm-operator {
  color: #AA22FF;
  font-weight: bold;
}
.cm-s-ipython span.cm-variable-2 {
  color: #1a1a1a;
}
.cm-s-ipython span.cm-variable-3 {
  color: #333333;
}
.cm-s-ipython span.cm-comment {
  color: #408080;
  font-style: italic;
}
.cm-s-ipython span.cm-string {
  color: #BA2121;
}
.cm-s-ipython span.cm-string-2 {
  color: #f50;
}
.cm-s-ipython span.cm-meta {
  color: #AA22FF;
}
.cm-s-ipython span.cm-qualifier {
  color: #555;
}
.cm-s-ipython span.cm-builtin {
  color: #008000;
}
.cm-s-ipython span.cm-bracket {
  color: #997;
}
.cm-s-ipython span.cm-tag {
  color: #170;
}
.cm-s-ipython span.cm-attribute {
  color: #00c;
}
.cm-s-ipython span.cm-header {
  color: blue;
}
.cm-s-ipython span.cm-quote {
  color: #090;
}
.cm-s-ipython span.cm-link {
  color: #00c;
}
.cm-s-ipython span.cm-error {
  color: #f00;
}
.cm-s-ipython span.cm-tab {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAAXNSR0IArs4c6QAAAGFJREFUSMft1LsRQFAQheHPowAKoACx3IgEKtaEHujDjORSgWTH/ZOdnZOcM/sgk/kFFWY0qV8foQwS4MKBCS3qR6ixBJvElOobYAtivseIE120FaowJPN75GMu8j/LfMwNjh4HUpwg4LUAAAAASUVORK5CYII=);
  background-position: right;
  background-repeat: no-repeat;
}
div.output_wrapper {
  /* this position must be relative to enable descendents to be absolute within it */
  position: relative;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
  z-index: 1;
}
/* class for the output area when it should be height-limited */
div.output_scroll {
  /* ideally, this would be max-height, but FF barfs all over that */
  height: 24em;
  /* FF needs this *and the wrapper* to specify full width, or it will shrinkwrap */
  width: 100%;
  overflow: auto;
  border-radius: 2px;
  -webkit-box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8);
  box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.8);
  display: block;
}
/* output div while it is collapsed */
div.output_collapsed {
  margin: 0px;
  padding: 0px;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
div.out_prompt_overlay {
  height: 100%;
  padding: 0px 0.4em;
  position: absolute;
  border-radius: 2px;
}
div.out_prompt_overlay:hover {
  /* use inner shadow to get border that is computed the same on WebKit/FF */
  -webkit-box-shadow: inset 0 0 1px #000;
  box-shadow: inset 0 0 1px #000;
  background: rgba(240, 240, 240, 0.5);
}
div.output_prompt {
  color: #D84315;
}
/* This class is the outer container of all output sections. */
div.output_area {
  padding: 0px;
  page-break-inside: avoid;
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
div.output_area .MathJax_Display {
  text-align: left !important;
}
div.output_area 
div.output_area 
div.output_area img,
div.output_area svg {
  max-width: 100%;
  height: auto;
}
div.output_area img.unconfined,
div.output_area svg.unconfined {
  max-width: none;
}
/* This is needed to protect the pre formating from global settings such
   as that of bootstrap */
.output {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: vertical;
  -moz-box-align: stretch;
  display: box;
  box-orient: vertical;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.output_area {
    /* Old browsers */
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-box-align: stretch;
    display: -moz-box;
    -moz-box-orient: vertical;
    -moz-box-align: stretch;
    display: box;
    box-orient: vertical;
    box-align: stretch;
    /* Modern browsers */
    display: flex;
    flex-direction: column;
    align-items: stretch;
  }
}
div.output_area pre {
  margin: 0;
  padding: 0;
  border: 0;
  vertical-align: baseline;
  color: black;
  background-color: transparent;
  border-radius: 0;
}
/* This class is for the output subarea inside the output_area and after
   the prompt div. */
div.output_subarea {
  overflow-x: auto;
  padding: 0.4em;
  /* Old browsers */
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  box-flex: 1;
  /* Modern browsers */
  flex: 1;
  max-width: calc(100% - 14ex);
}
div.output_scroll div.output_subarea {
  overflow-x: visible;
}
/* The rest of the output_* classes are for special styling of the different
   output types */
/* all text output has this class: */
div.output_text {
  text-align: left;
  color: #000;
  /* This has to match that of the the CodeMirror class line-height below */
  line-height: 1.21429em;
}
/* stdout/stderr are 'text' as well as 'stream', but execute_result/error are *not* streams */
div.output_stderr {
  background: #fdd;
  /* very light red background for stderr */
}
div.output_latex {
  text-align: left;
}
/* Empty output_javascript divs should have no height */
div.output_javascript:empty {
  padding: 0;
}
.js-error {
  color: darkred;
}
/* raw_input styles */
div.raw_input_container {
  line-height: 1.21429em;
  padding-top: 5px;
}
pre.raw_input_prompt {
  /* nothing needed here. */
}
input.raw_input {
  font-family: monospace;
  font-size: inherit;
  color: inherit;
  width: auto;
  /* make sure input baseline aligns with prompt */
  vertical-align: baseline;
  /* padding + margin = 0.5em between prompt and cursor */
  padding: 0em 0.25em;
  margin: 0em 0.25em;
}
input.raw_input:focus {
  box-shadow: none;
}
p.p-space {
  margin-bottom: 10px;
}
div.output_unrecognized {
  padding: 5px;
  font-weight: bold;
  color: red;
}
div.output_unrecognized a {
  color: inherit;
  text-decoration: none;
}
div.output_unrecognized a:hover {
  color: inherit;
  text-decoration: none;
}
.rendered_html {
  color: #000;
  /* any extras will just be numbers: */
}



.rendered_html :link {
  text-decoration: underline;
}
.rendered_html :visited {
  text-decoration: underline;
}






.rendered_html h1:first-child {
  margin-top: 0.538em;
}
.rendered_html h2:first-child {
  margin-top: 0.636em;
}
.rendered_html h3:first-child {
  margin-top: 0.777em;
}
.rendered_html h4:first-child {
  margin-top: 1em;
}
.rendered_html h5:first-child {
  margin-top: 1em;
}
.rendered_html h6:first-child {
  margin-top: 1em;
}








.rendered_html * + ul {
  margin-top: 1em;
}
.rendered_html * + ol {
  margin-top: 1em;
}


.rendered_html pre,



.rendered_html tr,
.rendered_html th,

.rendered_html td,


.rendered_html * + table {
  margin-top: 1em;
}

.rendered_html * + p {
  margin-top: 1em;
}

.rendered_html * + img {
  margin-top: 1em;
}
.rendered_html img,

.rendered_html img.unconfined,

div.text_cell {
  /* Old browsers */
  display: -webkit-box;
  -webkit-box-orient: horizontal;
  -webkit-box-align: stretch;
  display: -moz-box;
  -moz-box-orient: horizontal;
  -moz-box-align: stretch;
  display: box;
  box-orient: horizontal;
  box-align: stretch;
  /* Modern browsers */
  display: flex;
  flex-direction: row;
  align-items: stretch;
}
@media (max-width: 540px) {
  div.text_cell > div.prompt {
    display: none;
  }
}
div.text_cell_render {
  /*font-family: "Helvetica Neue", Arial, Helvetica, Geneva, sans-serif;*/
  outline: none;
  resize: none;
  width: inherit;
  border-style: none;
  padding: 0.5em 0.5em 0.5em 0.4em;
  color: #000;
  box-sizing: border-box;
  -moz-box-sizing: border-box;
  -webkit-box-sizing: border-box;
}
a.anchor-link:link {
  text-decoration: none;
  padding: 0px 20px;
  visibility: hidden;
}
h1:hover .anchor-link,
h2:hover .anchor-link,
h3:hover .anchor-link,
h4:hover .anchor-link,
h5:hover .anchor-link,
h6:hover .anchor-link {
  visibility: visible;
}
.text_cell.rendered .input_area {
  display: none;
}
.text_cell.rendered 
.text_cell.unrendered .text_cell_render {
  display: none;
}
.cm-header-1,
.cm-header-2,
.cm-header-3,
.cm-header-4,
.cm-header-5,
.cm-header-6 {
  font-weight: bold;
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
}
.cm-header-1 {
  font-size: 185.7%;
}
.cm-header-2 {
  font-size: 157.1%;
}
.cm-header-3 {
  font-size: 128.6%;
}
.cm-header-4 {
  font-size: 110%;
}
.cm-header-5 {
  font-size: 100%;
  font-style: italic;
}
.cm-header-6 {
  font-size: 100%;
  font-style: italic;
}
</style>
<style type="text/css">.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #BC7A00 } /* Comment.Preproc */
.highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #FF0000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #A0A000 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #666666 } /* Literal.Number.Bin */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sa { color: #BA2121 } /* Literal.String.Affix */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .dl { color: #BA2121 } /* Literal.String.Delimiter */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #BB6688 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0000FF } /* Name.Function.Magic */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .vm { color: #19177C } /* Name.Variable.Magic */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */</style>
<style type="text/css">
/* Temporary definitions which will become obsolete with Notebook release 5.0 */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }
</style><body>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="RDD-creation">RDD creation<a class="anchor-link" href="#RDD-creation">¶</a></h1><p>In this notebook we will introduce two different ways of getting data into the basic Spark data structure, the <strong>Resilient Distributed Dataset</strong> or <strong>RDD</strong>. An RDD is a distributed collection of elements. All work in Spark is expressed as either creating new RDDs, transforming existing RDDs, or calling actions on RDDs to compute a result. Spark automatically distributes the data contained in RDDs across your cluster and parallelizes the operations you perform on them.</p>
<h3 id="References">References<a class="anchor-link" href="#References">¶</a></h3><p>The reference book for these and other Spark related topics is <em>Learning Spark</em> by Holden Karau, Andy Konwinski, Patrick Wendell, and Matei Zaharia.</p>
<p>The KDD Cup 1999 competition dataset is described in detail <a href="http://kdd.ics.uci.edu/databases/kddcup99/kddcup99">here</a>.</p>
<h2 id="Getting-the-data-files">Getting the data files<a class="anchor-link" href="#Getting-the-data-files">¶</a></h2><p>In this notebook we will use the reduced dataset (10 percent) provided for the KDD Cup 1999, containing nearly half million network interactions. The file is provided as a <em>Gzip</em> file that we will download locally.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [1]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">urllib</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span> <span class="p">(</span><span class="s2">"http://kdd.ics.uci.edu/databases/kddcup99/kddcup.data_10_percent.gz"</span><span class="p">,</span> <span class="s2">"kddcup.data_10_percent.gz"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">AttributeError</span>                            Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-1-c9437f147d19&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> <span class="ansi-green-fg">import</span> urllib
<span class="ansi-green-fg">----&gt; 2</span><span class="ansi-red-fg"> </span>f <span class="ansi-blue-fg">=</span> urllib<span class="ansi-blue-fg">.</span>urlretrieve <span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">"http://kdd.ics.uci.edu/databases/kddcup99/kddcup.data_10_percent.gz"</span><span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">"kddcup.data_10_percent.gz"</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">AttributeError</span>: module 'urllib' has no attribute 'urlretrieve'</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Creating-a-RDD-from-a-file">Creating a RDD from a file<a class="anchor-link" href="#Creating-a-RDD-from-a-file">¶</a></h2><p>The most common way of creating an RDD is to load it from a file. Notice that Spark's <code>textFile</code> can handle compressed files directly.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [32]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data_file</span> <span class="o">=</span> <span class="s2">"./kddcup.data_10_percent.gz"</span>
<span class="n">raw_data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we have our data file loaded into the <code>raw_data</code> RDD.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Without getting into Spark <em>transformations</em> and <em>actions</em>, the most basic thing we can do to check that we got our RDD contents right is to <code>count()</code> the number of lines loaded from the file into the RDD.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [33]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">raw_data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[33]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>494021</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can also check the first few entries in our data.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [34]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">raw_data</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[34]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>[u'0,tcp,http,SF,181,5450,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,8,8,0.00,0.00,0.00,0.00,1.00,0.00,0.00,9,9,1.00,0.00,0.11,0.00,0.00,0.00,0.00,0.00,normal.',
 u'0,tcp,http,SF,239,486,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,8,8,0.00,0.00,0.00,0.00,1.00,0.00,0.00,19,19,1.00,0.00,0.05,0.00,0.00,0.00,0.00,0.00,normal.',
 u'0,tcp,http,SF,235,1337,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,8,8,0.00,0.00,0.00,0.00,1.00,0.00,0.00,29,29,1.00,0.00,0.03,0.00,0.00,0.00,0.00,0.00,normal.',
 u'0,tcp,http,SF,219,1337,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,6,6,0.00,0.00,0.00,0.00,1.00,0.00,0.00,39,39,1.00,0.00,0.03,0.00,0.00,0.00,0.00,0.00,normal.',
 u'0,tcp,http,SF,217,2032,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,6,6,0.00,0.00,0.00,0.00,1.00,0.00,0.00,49,49,1.00,0.00,0.02,0.00,0.00,0.00,0.00,0.00,normal.']</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In the following notebooks, we will use this raw data to learn about the different Spark transformations and actions.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Creating-and-RDD-using-parallelize">Creating and RDD using <code>parallelize</code><a class="anchor-link" href="#Creating-and-RDD-using-parallelize">¶</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Another way of creating an RDD is to parallelize an already existing list.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [35]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As we did before, we can <code>count()</code> the number of elements in the RDD.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [36]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[36]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>100</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As before, we can access the first few elements on our RDD.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [37]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[37]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>[0, 1, 2, 3, 4]</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="RDD-basics">RDD basics<a class="anchor-link" href="#RDD-basics">¶</a></h1><p>This notebook will introduce three basic but essential Spark operations. Two of them are the <em>transformations</em> <code>map</code> and <code>filter</code>. The other is the <em>action</em> <code>collect</code>. At the same time we will introduce the concept of <em>persistence</em> in Spark.</p>
<h2 id="Getting-the-data-and-creating-the-RDD">Getting the data and creating the RDD<a class="anchor-link" href="#Getting-the-data-and-creating-the-RDD">¶</a></h2><p>As we did in our first notebook, we will use the reduced dataset (10 percent) provided for the KDD Cup 1999, containing nearly half million network interactions. The file is provided as a Gzip file that we will download locally.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [ ]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">urllib</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span> <span class="p">(</span><span class="s2">"http://kdd.ics.uci.edu/databases/kddcup99/kddcup.data_10_percent.gz"</span><span class="p">,</span> <span class="s2">"kddcup.data_10_percent.gz"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we can use this file to create our RDD.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [1]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data_file</span> <span class="o">=</span> <span class="s2">"./kddcup.data_10_percent.gz"</span>
<span class="n">raw_data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="The-filter-transformation">The <code>filter</code> transformation<a class="anchor-link" href="#The-filter-transformation">¶</a></h2><p>This transformation can be applied to RDDs in order to keep just elements that satisfy a certain condition. More concretely, a function is evaluated on every element in the original RDD. The new resulting RDD will contain just those elements that make the function return <code>True</code>.</p>
<p>For example, imagine we want to count how many <code>normal.</code> interactions we have in our dataset. We can filter our <code>raw_data</code> RDD as follows.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [2]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">normal_raw_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">'normal.'</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we can count how many elements we have in the new RDD.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">normal_count</span> <span class="o">=</span> <span class="n">normal_raw_data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
<span class="nb">print</span> <span class="s2">"There are </span><span class="si">{}</span><span class="s2"> 'normal' interactions"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">normal_count</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">"Count completed in </span><span class="si">{}</span><span class="s2"> seconds"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>There are 97278 'normal' interactions
Count completed in 5.951 seconds
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Remember from notebook 1 that we have a total of 494021 in our 10 percent dataset. Here we can see that 97278 contain the <code>normal.</code> tag word.</p>
<p>Notice that we have measured the elapsed time for counting the elements in the RDD. We have done this because we wanted to point out that actual (distributed) computations in Spark take place when we execute <em>actions</em> and not <em>transformations</em>. In this case <code>count</code> is the action we execute on the RDD. We can apply as many transformations as we want on a our RDD and no computation will take place until we call the first action that, in this case takes a few seconds to complete.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="The-map-transformation">The <code>map</code> transformation<a class="anchor-link" href="#The-map-transformation">¶</a></h2><p>By using the <code>map</code> transformation in Spark, we can apply a function to every element in our RDD. Python's lambdas are specially expressive for this particular.</p>
<p>In this case we want to read our data file as a CSV formatted one. We can do this by applying a lambda function to each element in the RDD as follows.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pprint</span> <span class="k">import</span> <span class="n">pprint</span>
<span class="n">csv_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">))</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">head_rows</span> <span class="o">=</span> <span class="n">csv_data</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
<span class="nb">print</span> <span class="s2">"Parse completed in </span><span class="si">{}</span><span class="s2"> seconds"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">head_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Parse completed in 1.715 seconds
[u'0',
 u'tcp',
 u'http',
 u'SF',
 u'181',
 u'5450',
 u'0',
 u'0',
 u'0',
 u'0',
 u'0',
 u'1',
 u'0',
 u'0',
 u'0',
 u'0',
 u'0',
 u'0',
 u'0',
 u'0',
 u'0',
 u'0',
 u'8',
 u'8',
 u'0.00',
 u'0.00',
 u'0.00',
 u'0.00',
 u'1.00',
 u'0.00',
 u'0.00',
 u'9',
 u'9',
 u'1.00',
 u'0.00',
 u'0.11',
 u'0.00',
 u'0.00',
 u'0.00',
 u'0.00',
 u'0.00',
 u'normal.']
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Again, all action happens once we call the first Spark <em>action</em> (i.e. <em>take</em> in this case). What if we take a lot of elements instead of just the first few?</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [5]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">head_rows</span> <span class="o">=</span> <span class="n">csv_data</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
<span class="nb">print</span> <span class="s2">"Parse completed in </span><span class="si">{}</span><span class="s2"> seconds"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Parse completed in 8.629 seconds
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can see that it takes longer. The <code>map</code> function is applied now in a  distributed way to a lot of elements on the RDD, hence the longer execution time.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Using-map-and-predefined-functions">Using <code>map</code> and predefined functions<a class="anchor-link" href="#Using-map-and-predefined-functions">¶</a></h3><p>Of course we can use predefined functions with <code>map</code>. Imagine we want to have each element in the RDD as a key-value pair where the key is the tag (e.g. <em>normal</em>) and the value is the whole list of elements that represents the row in the CSV formatted file. We could proceed as follows.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [6]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">parse_interaction</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">elems</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">)</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">elems</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="n">elems</span><span class="p">)</span>

<span class="n">key_csv_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parse_interaction</span><span class="p">)</span>
<span class="n">head_rows</span> <span class="o">=</span> <span class="n">key_csv_data</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">head_rows</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>(u'normal.',
 [u'0',
  u'tcp',
  u'http',
  u'SF',
  u'181',
  u'5450',
  u'0',
  u'0',
  u'0',
  u'0',
  u'0',
  u'1',
  u'0',
  u'0',
  u'0',
  u'0',
  u'0',
  u'0',
  u'0',
  u'0',
  u'0',
  u'0',
  u'8',
  u'8',
  u'0.00',
  u'0.00',
  u'0.00',
  u'0.00',
  u'1.00',
  u'0.00',
  u'0.00',
  u'9',
  u'9',
  u'1.00',
  u'0.00',
  u'0.11',
  u'0.00',
  u'0.00',
  u'0.00',
  u'0.00',
  u'0.00',
  u'normal.'])
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>That was easy, wasn't it?</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In our notebook about working with key-value pairs we will use this type of RDDs to do data aggregations (e.g. count by key).</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="The-collect-action">The <code>collect</code> action<a class="anchor-link" href="#The-collect-action">¶</a></h2><p>So far we have used the actions <code>count</code> and <code>take</code>. Another basic action we need to learn is <code>collect</code>. Basically it will get all the elements in the RDD into memory for us to work with them. For this reason it has to be used with care, specially when working with large RDDs.</p>
<p>An example using our raw data.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [9]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">all_raw_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
<span class="nb">print</span> <span class="s2">"Data collected in </span><span class="si">{}</span><span class="s2"> seconds"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Data collected in 17.927 seconds
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>That took longer as any other action we used before, of course. Every Spark worker node that has a fragment of the RDD has to be coordinated in order to retrieve its part, and then <em>reduce</em> everything together.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As a last example combining all the previous, we want to collect all the <code>normal</code> interactions as key-value pairs.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [13]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># get data from file</span>
<span class="n">data_file</span> <span class="o">=</span> <span class="s2">"./kddcup.data_10_percent.gz"</span>
<span class="n">raw_data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>

<span class="c1"># parse into key-value pairs</span>
<span class="n">key_csv_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parse_interaction</span><span class="p">)</span>

<span class="c1"># filter normal key interactions</span>
<span class="n">normal_key_interactions</span> <span class="o">=</span> <span class="n">key_csv_data</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"normal."</span><span class="p">)</span>

<span class="c1"># collect all</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">all_normal</span> <span class="o">=</span> <span class="n">normal_key_interactions</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
<span class="n">normal_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_normal</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">"Data collected in </span><span class="si">{}</span><span class="s2"> seconds"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span> <span class="s2">"There are </span><span class="si">{}</span><span class="s2"> 'normal' interactions"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">normal_count</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Data collected in 12.485 seconds
There are 97278 normal interactions
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This count matches with the previous count for <code>normal</code> interactions. The new procedure is more time consuming. This is because we retrieve all the data with <code>collect</code> and then use Python's <code>len</code> on the resulting list. Before we were just counting the total number of elements in the RDD by using <code>count</code>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Sampling-RDDs">Sampling RDDs<a class="anchor-link" href="#Sampling-RDDs">¶</a></h1><p>So far we have introduced RDD creation together with some basic transformations such as <code>map</code> and <code>filter</code> and some actions such as <code>count</code>, <code>take</code>, and <code>collect</code>.</p>
<p>This notebook will show how to sample RDDs. Regarding transformations, <code>sample</code> will be introduced since it will be useful in many statistical learning scenarios. Then we will compare results with the <code>takeSample</code> action.</p>
<h2 id="Getting-the-data-and-creating-the-RDD">Getting the data and creating the RDD<a class="anchor-link" href="#Getting-the-data-and-creating-the-RDD">¶</a></h2><p>In this case we will use the complete dataset provided for the KDD Cup 1999, containing nearly half million network interactions. The file is provided as a Gzip file that we will download locally.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [1]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">urllib</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span> <span class="p">(</span><span class="s2">"http://kdd.ics.uci.edu/databases/kddcup99/kddcup.data.gz"</span><span class="p">,</span> <span class="s2">"kddcup.data.gz"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we can use this file to create our RDD.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [2]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data_file</span> <span class="o">=</span> <span class="s2">"./kddcup.data.gz"</span>
<span class="n">raw_data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Sampling-RDDs">Sampling RDDs<a class="anchor-link" href="#Sampling-RDDs">¶</a></h2><p>In Spark, there are two sampling operations, the transformation <code>sample</code> and the action <code>takeSample</code>. By using a transformation we can tell Spark to apply successive transformation on a sample of a given RDD. By using an action we retrieve a given sample and we can have it in local memory to be used by any other standard library (e.g. Scikit-learn).</p>
<h3 id="The-sample-transformation">The <code>sample</code> transformation<a class="anchor-link" href="#The-sample-transformation">¶</a></h3><p>The <code>sample</code> transformation takes up to three parameters. First is whether the sampling is done with replacement or not. Second is the sample size as a fraction. Finally we can optionally provide a <em>random seed</em>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">raw_data_sample</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1234</span><span class="p">)</span>
<span class="n">sample_size</span> <span class="o">=</span> <span class="n">raw_data_sample</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">total_size</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="nb">print</span> <span class="s2">"Sample size is </span><span class="si">{}</span><span class="s2"> of </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">total_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Sample size is 489957 of 4898431
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>But the power of sampling as a transformation comes from doing it as part of a sequence of additional transformations. This will show more powerful once we start doing aggregations and key-value pairs operations, and will be specially useful when using Spark's machine learning library MLlib.</p>
<p>In the meantime, imagine we want to have an approximation of the proportion of <code>normal.</code> interactions in our dataset. We could do this by counting the total number of tags as we did in previous notebooks. However we want a quicker response and we don't need the exact answer but just an approximation. We can do it as follows.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>

<span class="c1"># transformations to be applied</span>
<span class="n">raw_data_sample_items</span> <span class="o">=</span> <span class="n">raw_data_sample</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">))</span>
<span class="n">sample_normal_tags</span> <span class="o">=</span> <span class="n">raw_data_sample_items</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">"normal."</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>

<span class="c1"># actions + time</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">sample_normal_tags_count</span> <span class="o">=</span> <span class="n">sample_normal_tags</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="n">sample_normal_ratio</span> <span class="o">=</span> <span class="n">sample_normal_tags_count</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">sample_size</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">"The ratio of 'normal' interactions is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">sample_normal_ratio</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> 
<span class="nb">print</span> <span class="s2">"Count done in </span><span class="si">{}</span><span class="s2"> seconds"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>The ratio of 'normal' interactions is 0.199
Count done in 44.523 seconds
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's compare this with calculating the ratio without sampling.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [5]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># transformations to be applied</span>
<span class="n">raw_data_items</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">))</span>
<span class="n">normal_tags</span> <span class="o">=</span> <span class="n">raw_data_items</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">"normal."</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>

<span class="c1"># actions + time</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">normal_tags_count</span> <span class="o">=</span> <span class="n">normal_tags</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="n">normal_ratio</span> <span class="o">=</span> <span class="n">normal_tags_count</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">total_size</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">"The ratio of 'normal' interactions is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">normal_ratio</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> 
<span class="nb">print</span> <span class="s2">"Count done in </span><span class="si">{}</span><span class="s2"> seconds"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>The ratio of 'normal' interactions is 0.199
Count done in 91.09 seconds
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can see a gain in time. The more transformations we apply after the sampling the bigger this gain. This is because without sampling all the transformations are applied to the complete set of data.</p>
<h3 id="The-takeSample-action">The <code>takeSample</code> action<a class="anchor-link" href="#The-takeSample-action">¶</a></h3><p>If what we need is to grab a sample of raw data from our RDD into local memory in order to be used by other non-Spark libraries, <code>takeSample</code> can be used.</p>
<p>The syntax is very similar, but in this case we specify the number of items instead of the sample size as a fraction of the complete data size.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [6]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">raw_data_sample</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">takeSample</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="mi">400000</span><span class="p">,</span> <span class="mi">1234</span><span class="p">)</span>
<span class="n">normal_data_sample</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">raw_data_sample</span> <span class="k">if</span> <span class="s2">"normal."</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="n">normal_sample_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">normal_data_sample</span><span class="p">)</span>

<span class="n">normal_ratio</span> <span class="o">=</span> <span class="n">normal_sample_size</span> <span class="o">/</span> <span class="mf">400000.0</span>
<span class="nb">print</span> <span class="s2">"The ratio of 'normal' interactions is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">normal_ratio</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">"Count done in </span><span class="si">{}</span><span class="s2"> seconds"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>The ratio of 'normal' interactions is 0.1988025
Count done in 76.166 seconds
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The process was very similar as before. We obtained a sample of about 10 percent of the data, and then filter and split.</p>
<p>However, it took longer, even with a slightly smaller sample. The reason is that Spark just distributed the execution of the sampling process. The filtering and splitting of the results were done locally in a single node.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Set-operations-on-RDDs">Set operations on RDDs<a class="anchor-link" href="#Set-operations-on-RDDs">¶</a></h1><p>Spark supports many of the operations we have in mathematical sets, such as union and intersection, even when the RDDs themselves are not properly sets. It is important to note that these operations require that the RDDs being operated on are of the same type.</p>
<p>Set operations are quite straightforward to understand as it work as expected. The only consideration comes from the fact that RDDs are not real sets, and therefore operations such as the union of RDDs doesn't remove duplicates. In this notebook we will have a brief look at <code>subtract</code>, <code>distinct</code>, and <code>cartesian</code>.</p>
<h2 id="Getting-the-data-and-creating-the-RDD">Getting the data and creating the RDD<a class="anchor-link" href="#Getting-the-data-and-creating-the-RDD">¶</a></h2><p>As we did in our first notebook, we will use the reduced dataset (10 percent) provided for the KDD Cup 1999, containing nearly half million network interactions. The file is provided as a Gzip file that we will download locally.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [1]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">urllib</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span> <span class="p">(</span><span class="s2">"http://kdd.ics.uci.edu/databases/kddcup99/kddcup.data_10_percent.gz"</span><span class="p">,</span> <span class="s2">"kddcup.data_10_percent.gz"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [2]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data_file</span> <span class="o">=</span> <span class="s2">"./kddcup.data_10_percent.gz"</span>
<span class="n">raw_data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Getting-attack-interactions-using-subtract">Getting attack interactions using <code>subtract</code><a class="anchor-link" href="#Getting-attack-interactions-using-subtract">¶</a></h2><p>For illustrative purposes, imagine we already have our RDD with non attack (normal) interactions from some previous analysis.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">normal_raw_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">"normal."</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can obtain attack interactions by subtracting normal ones from the original unfiltered RDD as follows.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">attack_raw_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">normal_raw_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's do some counts to check our results.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [5]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>

<span class="c1"># count all</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">raw_data_count</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
<span class="nb">print</span> <span class="s2">"All count in </span><span class="si">{}</span><span class="s2"> secs"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>All count in 5.261 secs
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [6]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># count normal</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">normal_raw_data_count</span> <span class="o">=</span> <span class="n">normal_raw_data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
<span class="nb">print</span> <span class="s2">"Normal count in </span><span class="si">{}</span><span class="s2"> secs"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Normal count in 5.571 secs
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [7]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># count attacks</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">attack_raw_data_count</span> <span class="o">=</span> <span class="n">attack_raw_data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
<span class="nb">print</span> <span class="s2">"Attack count in </span><span class="si">{}</span><span class="s2"> secs"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Attack count in 12.075 secs
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [8]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="nb">print</span> <span class="s2">"There are </span><span class="si">{}</span><span class="s2"> normal interactions and </span><span class="si">{}</span><span class="s2"> attacks, </span><span class="se">\</span>
<span class="s2">from a total of </span><span class="si">{}</span><span class="s2"> interactions"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">normal_raw_data_count</span><span class="p">,</span><span class="n">attack_raw_data_count</span><span class="p">,</span><span class="n">raw_data_count</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>There are 97278 normal interactions and 396743 attacks, from a total of 494021 interactions
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So now we have two RDDs, one with normal interactions and another one with attacks.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Protocol-and-service-combinations-using-cartesian">Protocol and service combinations using <code>cartesian</code><a class="anchor-link" href="#Protocol-and-service-combinations-using-cartesian">¶</a></h2><p>We can compute the Cartesian product between two RDDs by using the <code>cartesian</code> transformation. It returns all possible pairs of elements between two RDDs. In our case we will use it to generate all the possible combinations between service and protocol in our network interactions.</p>
<p>First of all we need to isolate each collection of values in two separate RDDs. For that we will use <code>distinct</code> on the CSV-parsed dataset. From the <a href="http://kdd.ics.uci.edu/databases/kddcup99/kddcup.names">dataset description</a> we know that protocol is the second column and service is the third (tag is the last one and not the first as appears in the page).</p>
<p>So first, let's get the protocols.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [9]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">csv_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">))</span>
<span class="n">protocols</span> <span class="o">=</span> <span class="n">csv_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
<span class="n">protocols</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[9]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>[u'udp', u'icmp', u'tcp']</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we do the same for services.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [10]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">services</span> <span class="o">=</span> <span class="n">csv_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
<span class="n">services</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[10]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>[u'domain',
 u'http_443',
 u'Z39_50',
 u'smtp',
 u'urp_i',
 u'private',
 u'echo',
 u'shell',
 u'red_i',
 u'eco_i',
 u'sunrpc',
 u'ftp_data',
 u'urh_i',
 u'pm_dump',
 u'pop_3',
 u'pop_2',
 u'systat',
 u'ftp',
 u'uucp',
 u'whois',
 u'netbios_dgm',
 u'efs',
 u'remote_job',
 u'daytime',
 u'ntp_u',
 u'finger',
 u'ldap',
 u'netbios_ns',
 u'kshell',
 u'iso_tsap',
 u'ecr_i',
 u'nntp',
 u'printer',
 u'domain_u',
 u'uucp_path',
 u'courier',
 u'exec',
 u'time',
 u'netstat',
 u'telnet',
 u'gopher',
 u'rje',
 u'sql_net',
 u'link',
 u'auth',
 u'netbios_ssn',
 u'csnet_ns',
 u'X11',
 u'IRC',
 u'tftp_u',
 u'login',
 u'supdup',
 u'name',
 u'nnsp',
 u'mtp',
 u'http',
 u'bgp',
 u'ctf',
 u'hostnames',
 u'klogin',
 u'vmnet',
 u'tim_i',
 u'discard',
 u'imap4',
 u'other',
 u'ssh']</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A longer list in this case.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we can do the cartesian product.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [11]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">product</span> <span class="o">=</span> <span class="n">protocols</span><span class="o">.</span><span class="n">cartesian</span><span class="p">(</span><span class="n">services</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="nb">print</span> <span class="s2">"There are </span><span class="si">{}</span><span class="s2"> combinations of protocol X service"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">product</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>There are 198 combinations of protocol X service
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Obviously, for such small RDDs doesn't really make sense to use Spark cartesian product. We could have perfectly collected the values after using <code>distinct</code> and do the cartesian product locally. Moreover, <code>distinct</code> and <code>cartesian</code> are expensive operations so they must be used with care when the operating datasets are large.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Data-aggregations-on-RDDs">Data aggregations on RDDs<a class="anchor-link" href="#Data-aggregations-on-RDDs">¶</a></h1><p>We can aggregate RDD data in Spark by using three different actions: <code>reduce</code>, <code>fold</code>, and <code>aggregate</code>. The last one is the more general one and someway includes the first two.</p>
<h2 id="Getting-the-data-and-creating-the-RDD">Getting the data and creating the RDD<a class="anchor-link" href="#Getting-the-data-and-creating-the-RDD">¶</a></h2><p>As we did in our first notebook, we will use the reduced dataset (10 percent) provided for the <a href="http://kdd.ics.uci.edu/databases/kddcup99/kddcup99.html">KDD Cup 1999</a>, containing nearly half million nework interactions. The file is provided as a Gzip file that we will download locally.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [1]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">urllib</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span> <span class="p">(</span><span class="s2">"http://kdd.ics.uci.edu/databases/kddcup99/kddcup.data_10_percent.gz"</span><span class="p">,</span> <span class="s2">"kddcup.data_10_percent.gz"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [2]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data_file</span> <span class="o">=</span> <span class="s2">"./kddcup.data_10_percent.gz"</span>
<span class="n">raw_data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Inspecting-interaction-duration-by-tag">Inspecting interaction duration by tag<a class="anchor-link" href="#Inspecting-interaction-duration-by-tag">¶</a></h2><p>Both <code>fold</code> and <code>reduce</code> take a function as an argument that is applied to two elements of the RDD. The <code>fold</code> action differs from <code>reduce</code> in that it gets and additional initial <em>zero value</em> to be used for the initial call. This value should be the identity element for the function provided.</p>
<p>As an example, imagine we want to know the total duration of our interactions for normal and attack interactions. We can use <code>reduce</code> as follows.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># parse data</span>
<span class="n">csv_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">))</span>

<span class="c1"># separate into different RDDs</span>
<span class="n">normal_csv_data</span> <span class="o">=</span> <span class="n">csv_data</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span><span class="o">==</span><span class="s2">"normal."</span><span class="p">)</span>
<span class="n">attack_csv_data</span> <span class="o">=</span> <span class="n">csv_data</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span><span class="o">!=</span><span class="s2">"normal."</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The function that we pass to <code>reduce</code> gets and returns elements of the same type of the RDD. If we want to sum durations we need to extract that element into a new RDD.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">normal_duration_data</span> <span class="o">=</span> <span class="n">normal_csv_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">attack_duration_data</span> <span class="o">=</span> <span class="n">attack_csv_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we can reduce these new RDDs.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [5]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">total_normal_duration</span> <span class="o">=</span> <span class="n">normal_duration_data</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>
<span class="n">total_attack_duration</span> <span class="o">=</span> <span class="n">attack_duration_data</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>

<span class="nb">print</span> <span class="s2">"Total duration for 'normal' interactions is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span>\
    <span class="nb">format</span><span class="p">(</span><span class="n">total_normal_duration</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">"Total duration for 'attack' interactions is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span>\
    <span class="nb">format</span><span class="p">(</span><span class="n">total_attack_duration</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Total duration for 'normal' interactions is 21075991
Total duration for 'attack' interactions is 2626792
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can go further and use counts to calculate duration means.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [6]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">normal_count</span> <span class="o">=</span> <span class="n">normal_duration_data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="n">attack_count</span> <span class="o">=</span> <span class="n">attack_duration_data</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

<span class="nb">print</span> <span class="s2">"Mean duration for 'normal' interactions is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span>\
    <span class="nb">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">total_normal_duration</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">normal_count</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span> <span class="s2">"Mean duration for 'attack' interactions is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span>\
    <span class="nb">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">total_attack_duration</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">attack_count</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Mean duration for 'normal' interactions is 216.657
Mean duration for 'attack' interactions is 6.621
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We have a first (and too simplistic) approach to identify attack interactions.</p>
<h2 id="A-better-way,-using-aggregate">A better way, using <code>aggregate</code><a class="anchor-link" href="#A-better-way,-using-aggregate">¶</a></h2><p>The <code>aggregate</code> action frees us from the constraint of having the return be the same type as the RDD we are working on. Like with <code>fold</code>, we supply an initial zero value of the type we want to return. Then we provide two functions. The first one is used to combine the elements from our RDD with the accumulator. The second function is needed to merge two accumulators. Let's see it in action calculating the mean we did before.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [7]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">normal_sum_count</span> <span class="o">=</span> <span class="n">normal_duration_data</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="c1"># the initial value</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="n">acc</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="p">(</span><span class="n">acc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">value</span><span class="p">,</span> <span class="n">acc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span> <span class="c1"># combine value with acc</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="n">acc1</span><span class="p">,</span> <span class="n">acc2</span><span class="p">:</span> <span class="p">(</span><span class="n">acc1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">acc2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">acc1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">acc2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># combine accumulators</span>
<span class="p">)</span>

<span class="nb">print</span> <span class="s2">"Mean duration for 'normal' interactions is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span>\
    <span class="nb">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">normal_sum_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">normal_sum_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Mean duration for 'normal' interactions is 216.657
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In the previous aggregation, the accumulator first element keeps the total sum, while the second element keeps the count. Combining an accumulator with an RDD element consists in summing up the value and incrementing the count. Combining two accumulators requires just a pairwise sum.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can do the same with attack type interactions.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [8]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">attack_sum_count</span> <span class="o">=</span> <span class="n">attack_duration_data</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
    <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="c1"># the initial value</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="n">acc</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="p">(</span><span class="n">acc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">value</span><span class="p">,</span> <span class="n">acc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span> <span class="c1"># combine value with acc</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="n">acc1</span><span class="p">,</span> <span class="n">acc2</span><span class="p">:</span> <span class="p">(</span><span class="n">acc1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">acc2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">acc1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">acc2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># combine accumulators</span>
<span class="p">)</span>

<span class="nb">print</span> <span class="s2">"Mean duration for 'attack' interactions is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span>\
    <span class="nb">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">attack_sum_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">attack_sum_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Mean duration for 'attack' interactions is 6.621
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Working-with-key/value-pair-RDDs">Working with key/value pair RDDs<a class="anchor-link" href="#Working-with-key/value-pair-RDDs">¶</a></h1><p>Spark provides specific functions to deal with RDDs which elements are key/value pairs. They are usually used to perform aggregations and other processings by key.</p>
<p>In this notebook we will show how, by working with key/value pairs, we can process our network interactions dataset in a more practical and powerful way than that used in previous notebooks. Key/value pair aggregations will show to be particularly effective when trying to explore each type of tag in our network attacks, in an individual way.</p>
<h2 id="Getting-the-data-and-creating-the-RDD">Getting the data and creating the RDD<a class="anchor-link" href="#Getting-the-data-and-creating-the-RDD">¶</a></h2><p>As we did in our first notebook, we will use the reduced dataset (10 percent) provided for the <a href="http://kdd.ics.uci.edu/databases/kddcup99/kddcup99.html">KDD Cup 1999</a>, containing nearly half million network interactions. The file is provided as a Gzip file that we will download locally.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [1]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">urllib</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span> <span class="p">(</span><span class="s2">"http://kdd.ics.uci.edu/databases/kddcup99/kddcup.data_10_percent.gz"</span><span class="p">,</span> <span class="s2">"kddcup.data_10_percent.gz"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [1]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data_file</span> <span class="o">=</span> <span class="s2">"./kddcup.data_10_percent.gz"</span>
<span class="n">raw_data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Creating-a-pair-RDD-for-interaction-types">Creating a pair RDD for interaction types<a class="anchor-link" href="#Creating-a-pair-RDD-for-interaction-types">¶</a></h2><p>In this notebook we want to do some exploratory data analysis on our network interactions dataset. More concretely we want to profile each network interaction type in terms of some of its variables such as duration. In order to do so, we first need to create the RDD suitable for that, where each interaction is parsed as a CSV row representing the value, and is put together with its corresponding tag as a key.</p>
<p>Normally we create key/value pair RDDs by applying a function using <code>map</code> to the original data. This function returns the corresponding pair for a given RDD element. We can proceed as follows.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [2]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">csv_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">))</span>
<span class="n">key_value_data</span> <span class="o">=</span> <span class="n">csv_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">41</span><span class="p">],</span> <span class="n">x</span><span class="p">))</span> <span class="c1"># x[41] contains the network interaction tag</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We have now our key/value pair data ready to be used. Let's get the first element in order to see how it looks like.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">key_value_data</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[3]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>[(u'normal.',
  [u'0',
   u'tcp',
   u'http',
   u'SF',
   u'181',
   u'5450',
   u'0',
   u'0',
   u'0',
   u'0',
   u'0',
   u'1',
   u'0',
   u'0',
   u'0',
   u'0',
   u'0',
   u'0',
   u'0',
   u'0',
   u'0',
   u'0',
   u'8',
   u'8',
   u'0.00',
   u'0.00',
   u'0.00',
   u'0.00',
   u'1.00',
   u'0.00',
   u'0.00',
   u'9',
   u'9',
   u'1.00',
   u'0.00',
   u'0.11',
   u'0.00',
   u'0.00',
   u'0.00',
   u'0.00',
   u'0.00',
   u'normal.'])]</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Data-aggregations-with-key/value-pair-RDDs">Data aggregations with key/value pair RDDs<a class="anchor-link" href="#Data-aggregations-with-key/value-pair-RDDs">¶</a></h2><p>We can use all the transformations and actions available for normal RDDs with key/value pair RDDs. We just need to make the functions work with pair elements. Additionally, Spark provides specific functions to work with RDDs containing pair elements. They are very similar to those available for general RDDs.</p>
<p>For example, we have a <code>reduceByKey</code> transformation that we can use as follows to calculate the total duration of each network interaction type.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">key_value_duration</span> <span class="o">=</span> <span class="n">csv_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">41</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> 
<span class="n">durations_by_key</span> <span class="o">=</span> <span class="n">key_value_duration</span><span class="o">.</span><span class="n">reduceByKey</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">)</span>

<span class="n">durations_by_key</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[4]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>[(u'guess_passwd.', 144.0),
 (u'nmap.', 0.0),
 (u'warezmaster.', 301.0),
 (u'rootkit.', 1008.0),
 (u'warezclient.', 627563.0),
 (u'smurf.', 0.0),
 (u'pod.', 0.0),
 (u'neptune.', 0.0),
 (u'normal.', 21075991.0),
 (u'spy.', 636.0),
 (u'ftp_write.', 259.0),
 (u'phf.', 18.0),
 (u'portsweep.', 1991911.0),
 (u'teardrop.', 0.0),
 (u'buffer_overflow.', 2751.0),
 (u'land.', 0.0),
 (u'imap.', 72.0),
 (u'loadmodule.', 326.0),
 (u'perl.', 124.0),
 (u'multihop.', 1288.0),
 (u'back.', 284.0),
 (u'ipsweep.', 43.0),
 (u'satan.', 64.0)]</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We have a specific counting action for key/value pairs.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [5]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">counts_by_key</span> <span class="o">=</span> <span class="n">key_value_data</span><span class="o">.</span><span class="n">countByKey</span><span class="p">()</span>
<span class="n">counts_by_key</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[5]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>defaultdict(&lt;type 'int'&gt;, {u'guess_passwd.': 53, u'nmap.': 231, u'warezmaster.': 20, u'rootkit.': 10, u'warezclient.': 1020, u'smurf.': 280790, u'pod.': 264, u'neptune.': 107201, u'normal.': 97278, u'spy.': 2, u'ftp_write.': 8, u'phf.': 4, u'portsweep.': 1040, u'teardrop.': 979, u'buffer_overflow.': 30, u'land.': 21, u'imap.': 12, u'loadmodule.': 9, u'perl.': 3, u'multihop.': 7, u'back.': 2203, u'ipsweep.': 1247, u'satan.': 1589})</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Using-combineByKey">Using <code>combineByKey</code><a class="anchor-link" href="#Using-combineByKey">¶</a></h3><p>This is the most general of the per-key aggregation functions. Most of the other per-key combiners are implemented using it. We can think about it as the <code>aggregate</code> equivalent since it allows the user to return values that are not the same type as our input data.</p>
<p>For example, we can use it to calculate per-type average durations as follows.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [6]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">sum_counts</span> <span class="o">=</span> <span class="n">key_value_duration</span><span class="o">.</span><span class="n">combineByKey</span><span class="p">(</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="c1"># the initial value, with value x and count 1</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="n">acc</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="p">(</span><span class="n">acc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">value</span><span class="p">,</span> <span class="n">acc</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span> <span class="c1"># how to combine a pair value with the accumulator: sum value, and increment count</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="n">acc1</span><span class="p">,</span> <span class="n">acc2</span><span class="p">:</span> <span class="p">(</span><span class="n">acc1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">acc2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">acc1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">acc2</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="c1"># combine accumulators</span>
<span class="p">)</span>

<span class="n">sum_counts</span><span class="o">.</span><span class="n">collectAsMap</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[6]:</div>
<div class="output_text output_subarea output_execute_result">
<pre>{u'back.': (284.0, 2203),
 u'buffer_overflow.': (2751.0, 30),
 u'ftp_write.': (259.0, 8),
 u'guess_passwd.': (144.0, 53),
 u'imap.': (72.0, 12),
 u'ipsweep.': (43.0, 1247),
 u'land.': (0.0, 21),
 u'loadmodule.': (326.0, 9),
 u'multihop.': (1288.0, 7),
 u'neptune.': (0.0, 107201),
 u'nmap.': (0.0, 231),
 u'normal.': (21075991.0, 97278),
 u'perl.': (124.0, 3),
 u'phf.': (18.0, 4),
 u'pod.': (0.0, 264),
 u'portsweep.': (1991911.0, 1040),
 u'rootkit.': (1008.0, 10),
 u'satan.': (64.0, 1589),
 u'smurf.': (0.0, 280790),
 u'spy.': (636.0, 2),
 u'teardrop.': (0.0, 979),
 u'warezclient.': (627563.0, 1020),
 u'warezmaster.': (301.0, 20)}</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can see that the arguments are pretty similar to those passed to <code>aggregate</code> in the previous notebook. The result associated to each type is in the form of a pair. If we want to actually get the averages, we need to do the division before collecting the results.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [7]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">duration_means_by_type</span> <span class="o">=</span> <span class="n">sum_counts</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">):</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">3</span><span class="p">)))</span><span class="o">.</span><span class="n">collectAsMap</span><span class="p">()</span>

<span class="c1"># Print them sorted</span>
<span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">duration_means_by_type</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">duration_means_by_type</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="nb">print</span> <span class="n">tag</span><span class="p">,</span> <span class="n">duration_means_by_type</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>portsweep. 1915.299
warezclient. 615.258
spy. 318.0
normal. 216.657
multihop. 184.0
rootkit. 100.8
buffer_overflow. 91.7
perl. 41.333
loadmodule. 36.222
ftp_write. 32.375
warezmaster. 15.05
imap. 6.0
phf. 4.5
guess_passwd. 2.717
back. 0.129
satan. 0.04
ipsweep. 0.034
nmap. 0.0
smurf. 0.0
pod. 0.0
neptune. 0.0
teardrop. 0.0
land. 0.0
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A small step into understanding what makes a network interaction be considered an attack.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="MLlib:-Basic-Statistics-and-Exploratory-Data-Analysis">MLlib: Basic Statistics and Exploratory Data Analysis<a class="anchor-link" href="#MLlib:-Basic-Statistics-and-Exploratory-Data-Analysis">¶</a></h1><p>So far we have used different map and aggregation functions, on simple and key/value pair RDD's, in order to get simple statistics that help us understand our datasets. In this notebook we will introduce Spark's machine learning library <a href="https://spark.apache.org/docs/latest/mllib-guide.html">MLlib</a> through its basic statistics functionality in order to better understand our dataset. We will use the reduced 10-percent <a href="http://kdd.ics.uci.edu/databases/kddcup99/kddcup99.html">KDD Cup 1999</a> datasets through the notebook.</p>
<h2 id="Getting-the-data-and-creating-the-RDD">Getting the data and creating the RDD<a class="anchor-link" href="#Getting-the-data-and-creating-the-RDD">¶</a></h2><p>As we did in our first notebook, we will use the reduced dataset (10 percent) provided for the <a href="http://kdd.ics.uci.edu/databases/kddcup99/kddcup99.html">KDD Cup 1999</a>, containing nearly half million network interactions. The file is provided as a Gzip file that we will download locally.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [1]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">urllib</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span> <span class="p">(</span><span class="s2">"http://kdd.ics.uci.edu/databases/kddcup99/kddcup.data_10_percent.gz"</span><span class="p">,</span> <span class="s2">"kddcup.data_10_percent.gz"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [2]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data_file</span> <span class="o">=</span> <span class="s2">"./kddcup.data_10_percent.gz"</span>
<span class="n">raw_data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Local-vectors">Local vectors<a class="anchor-link" href="#Local-vectors">¶</a></h2><p>A <a href="https://spark.apache.org/docs/latest/mllib-data-types.html#local-vector">local vector</a> is often used as a base type for RDDs in Spark MLlib. A local vector has integer-typed and 0-based indices and double-typed values, stored on a single machine. MLlib supports two types of local vectors: dense and sparse. A dense vector is backed by a double array representing its entry values, while a sparse vector is backed by two parallel arrays: indices and values.</p>
<p>For dense vectors, MLlib uses either Python <em>lists</em> or the <em>NumPy</em> <code>array</code> type. The later is recommended, so you can simply pass NumPy arrays around.</p>
<p>For sparse vectors, users can construct a <code>SparseVector</code> object from MLlib or pass <em>SciPy</em> <code>scipy.sparse</code> column vectors if SciPy is available in their environment. The easiest way to create sparse vectors is to use the factory methods implemented in <code>Vectors</code>.</p>
<h3 id="An-RDD-of-dense-vectors">An RDD of dense vectors<a class="anchor-link" href="#An-RDD-of-dense-vectors">¶</a></h3><p>Let's represent each network interaction in our dataset as a dense vector. For that we will use the <em>NumPy</em> <code>array</code> type.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">parse_interaction</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">line_split</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">)</span>
    <span class="c1"># keep just numeric and logical values</span>
    <span class="n">symbolic_indexes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">41</span><span class="p">]</span>
    <span class="n">clean_line_split</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line_split</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">symbolic_indexes</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">clean_line_split</span><span class="p">])</span>

<span class="n">vector_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parse_interaction</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Summary-statistics">Summary statistics<a class="anchor-link" href="#Summary-statistics">¶</a></h2><p>Spark's MLlib provides column summary statistics for <code>RDD[Vector]</code> through the function <a href="https://spark.apache.org/docs/latest/api/python/pyspark.mllib.html#pyspark.mllib.stat.Statistics.colStats"><code>colStats</code></a> available in <a href="https://spark.apache.org/docs/latest/api/python/pyspark.mllib.html#pyspark.mllib.stat.Statistics"><code>Statistics</code></a>. The method returns an instance of <a href="https://spark.apache.org/docs/latest/api/python/pyspark.mllib.html#pyspark.mllib.stat.MultivariateStatisticalSummary"><code>MultivariateStatisticalSummary</code></a>, which contains the column-wise <em>max</em>, <em>min</em>, <em>mean</em>, <em>variance</em>, and <em>number of nonzeros</em>, as well as the <em>total count</em>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.mllib.stat</span> <span class="k">import</span> <span class="n">Statistics</span> 
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">sqrt</span> 

<span class="c1"># Compute column summary statistics.</span>
<span class="n">summary</span> <span class="o">=</span> <span class="n">Statistics</span><span class="o">.</span><span class="n">colStats</span><span class="p">(</span><span class="n">vector_data</span><span class="p">)</span>

<span class="nb">print</span> <span class="s2">"Duration Statistics:"</span>
<span class="nb">print</span> <span class="s2">" Mean: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span> <span class="s2">" St. deviation: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">variance</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span> <span class="s2">" Max value: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">max</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span> <span class="s2">" Min value: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">min</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span> <span class="s2">" Total value count: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="nb">print</span> <span class="s2">" Number of non-zero values: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">numNonzeros</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Duration Statistics:
 Mean: 47.979
 St. deviation: 707.746
 Max value: 58329.0
 Min value: 0.0
 Total value count: 494021
 Number of non-zero values: 12350.0
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Summary-statistics-by-label">Summary statistics by label<a class="anchor-link" href="#Summary-statistics-by-label">¶</a></h3><p>The interesting part of summary statistics, in our case, comes from being able to obtain them by the type of network attack or 'label' in our dataset. By doing so we will be able to better characterise our dataset dependent variable in terms of the independent variables range of values.</p>
<p>If we want to do such a thing we could filter our RDD containing labels as keys and vectors as values. For that we just need to adapt our <code>parse_interaction</code> function to return a tuple with both elements.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [5]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">parse_interaction_with_key</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">line_split</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">)</span>
    <span class="c1"># keep just numeric and logical values</span>
    <span class="n">symbolic_indexes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">41</span><span class="p">]</span>
    <span class="n">clean_line_split</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line_split</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">symbolic_indexes</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">line_split</span><span class="p">[</span><span class="mi">41</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">clean_line_split</span><span class="p">]))</span>

<span class="n">label_vector_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parse_interaction_with_key</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The next step is not very sophisticated. We use <code>filter</code> on the RDD to leave out other labels but the one we want to gather statistics from.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [6]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">normal_label_data</span> <span class="o">=</span> <span class="n">label_vector_data</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="s2">"normal."</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we can use the new RDD to call <code>colStats</code> on the values.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [7]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">normal_summary</span> <span class="o">=</span> <span class="n">Statistics</span><span class="o">.</span><span class="n">colStats</span><span class="p">(</span><span class="n">normal_label_data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And collect the results as we did before.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [8]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="nb">print</span> <span class="s2">"Duration Statistics for label: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"normal"</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">" Mean: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">normal_summary</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">" St. deviation: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">normal_summary</span><span class="o">.</span><span class="n">variance</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span> <span class="s2">" Max value: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">normal_summary</span><span class="o">.</span><span class="n">max</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span> <span class="s2">" Min value: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">normal_summary</span><span class="o">.</span><span class="n">min</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span> <span class="s2">" Total value count: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">normal_summary</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="nb">print</span> <span class="s2">" Number of non-zero values: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">normal_summary</span><span class="o">.</span><span class="n">numNonzeros</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Duration Statistics for label: normal
 Mean: 216.657322313
 St. deviation: 1359.213
 Max value: 58329.0
 Min value: 0.0
 Total value count: 97278
 Number of non-zero values: 11690.0
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Instead of working with a key/value pair we could have just filter our raw data split using the label in column 41. Then we can parse the results as we did before. This will work as well. However having our data organised as key/value pairs will open the door to better manipulations. Since <code>values()</code> is a transformation on an RDD, and not an action, we don't perform any computation until we call <code>colStats</code> anyway.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>But lets wrap this within a function so we can reuse it with any label.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [9]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">summary_by_label</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="n">label_vector_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parse_interaction_with_key</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="n">label</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Statistics</span><span class="o">.</span><span class="n">colStats</span><span class="p">(</span><span class="n">label_vector_data</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's give it a try with the "normal." label again.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [10]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">normal_sum</span> <span class="o">=</span> <span class="n">summary_by_label</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="s2">"normal."</span><span class="p">)</span>

<span class="nb">print</span> <span class="s2">"Duration Statistics for label: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"normal"</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">" Mean: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">normal_sum</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">" St. deviation: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">normal_sum</span><span class="o">.</span><span class="n">variance</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span> <span class="s2">" Max value: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">normal_sum</span><span class="o">.</span><span class="n">max</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span> <span class="s2">" Min value: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">normal_sum</span><span class="o">.</span><span class="n">min</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span> <span class="s2">" Total value count: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">normal_sum</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="nb">print</span> <span class="s2">" Number of non-zero values: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">normal_sum</span><span class="o">.</span><span class="n">numNonzeros</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Duration Statistics for label: normal
 Mean: 216.657322313
 St. deviation: 1359.213
 Max value: 58329.0
 Min value: 0.0
 Total value count: 97278
 Number of non-zero values: 11690.0
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's try now with some network attack. We have all of them listed <a href="http://kdd.ics.uci.edu/databases/kddcup99/training_attack_types">here</a>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [11]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">guess_passwd_summary</span> <span class="o">=</span> <span class="n">summary_by_label</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="s2">"guess_passwd."</span><span class="p">)</span>

<span class="nb">print</span> <span class="s2">"Duration Statistics for label: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">"guess_password"</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">" Mean: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">guess_passwd_summary</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">" St. deviation: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">guess_passwd_summary</span><span class="o">.</span><span class="n">variance</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span> <span class="s2">" Max value: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">guess_passwd_summary</span><span class="o">.</span><span class="n">max</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span> <span class="s2">" Min value: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">guess_passwd_summary</span><span class="o">.</span><span class="n">min</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">print</span> <span class="s2">" Total value count: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">guess_passwd_summary</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="nb">print</span> <span class="s2">" Number of non-zero values: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">guess_passwd_summary</span><span class="o">.</span><span class="n">numNonzeros</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Duration Statistics for label: guess_password
 Mean: 2.71698113208
 St. deviation: 11.88
 Max value: 60.0
 Min value: 0.0
 Total value count: 53
 Number of non-zero values: 4.0
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can see that this type of attack is shorter in duration than a normal interaction. We could build a table with duration statistics for each type of interaction in our dataset. First we need to get a list of labels as described in the first line <a href="http://kdd.ics.uci.edu/databases/kddcup99/kddcup.names">here</a>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [12]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">label_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"back."</span><span class="p">,</span><span class="s2">"buffer_overflow."</span><span class="p">,</span><span class="s2">"ftp_write."</span><span class="p">,</span><span class="s2">"guess_passwd."</span><span class="p">,</span>
              <span class="s2">"imap."</span><span class="p">,</span><span class="s2">"ipsweep."</span><span class="p">,</span><span class="s2">"land."</span><span class="p">,</span><span class="s2">"loadmodule."</span><span class="p">,</span><span class="s2">"multihop."</span><span class="p">,</span>
              <span class="s2">"neptune."</span><span class="p">,</span><span class="s2">"nmap."</span><span class="p">,</span><span class="s2">"normal."</span><span class="p">,</span><span class="s2">"perl."</span><span class="p">,</span><span class="s2">"phf."</span><span class="p">,</span><span class="s2">"pod."</span><span class="p">,</span><span class="s2">"portsweep."</span><span class="p">,</span>
              <span class="s2">"rootkit."</span><span class="p">,</span><span class="s2">"satan."</span><span class="p">,</span><span class="s2">"smurf."</span><span class="p">,</span><span class="s2">"spy."</span><span class="p">,</span><span class="s2">"teardrop."</span><span class="p">,</span><span class="s2">"warezclient."</span><span class="p">,</span>
              <span class="s2">"warezmaster."</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Then we get a list of statistics for each label.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [13]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">stats_by_label</span> <span class="o">=</span> <span class="p">[(</span><span class="n">label</span><span class="p">,</span> <span class="n">summary_by_label</span><span class="p">(</span><span class="n">raw_data</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">label_list</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we get the <em>duration</em> column, first in our dataset (i.e. index 0).</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [14]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">duration_by_label</span> <span class="o">=</span> <span class="p">[</span> 
    <span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">variance</span><span class="p">()[</span><span class="mi">0</span><span class="p">])),</span> <span class="nb">float</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">())]))</span> 
    <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats_by_label</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>That we can put into a Pandas data frame.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [15]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">'display.max_columns'</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">stats_by_label_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_items</span><span class="p">(</span><span class="n">duration_by_label</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"Mean"</span><span class="p">,</span> <span class="s2">"Std Dev"</span><span class="p">,</span> <span class="s2">"Min"</span><span class="p">,</span> <span class="s2">"Max"</span><span class="p">,</span> <span class="s2">"Count"</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s1">'index'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And print it.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [16]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="nb">print</span> <span class="s2">"Duration statistics, by label"</span>
<span class="n">stats_by_label_df</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Duration statistics, by label
</pre>
</div>
</div>
<div class="output_area">
<div class="prompt output_prompt">Out[16]:</div>
<div class="output_html rendered_html output_subarea output_execute_result">
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>Mean</th>
<th>Std Dev</th>
<th>Min</th>
<th>Max</th>
<th>Count</th>
</tr>
</thead>
<tbody>
<tr>
<th>back.</th>
<td>    0.128915</td>
<td>    1.110062</td>
<td>   0</td>
<td>    14</td>
<td>   2203</td>
</tr>
<tr>
<th>buffer_overflow.</th>
<td>   91.700000</td>
<td>   97.514685</td>
<td>   0</td>
<td>   321</td>
<td>     30</td>
</tr>
<tr>
<th>ftp_write.</th>
<td>   32.375000</td>
<td>   47.449033</td>
<td>   0</td>
<td>   134</td>
<td>      8</td>
</tr>
<tr>
<th>guess_passwd.</th>
<td>    2.716981</td>
<td>   11.879811</td>
<td>   0</td>
<td>    60</td>
<td>     53</td>
</tr>
<tr>
<th>imap.</th>
<td>    6.000000</td>
<td>   14.174240</td>
<td>   0</td>
<td>    41</td>
<td>     12</td>
</tr>
<tr>
<th>ipsweep.</th>
<td>    0.034483</td>
<td>    0.438439</td>
<td>   0</td>
<td>     7</td>
<td>   1247</td>
</tr>
<tr>
<th>land.</th>
<td>    0.000000</td>
<td>    0.000000</td>
<td>   0</td>
<td>     0</td>
<td>     21</td>
</tr>
<tr>
<th>loadmodule.</th>
<td>   36.222222</td>
<td>   41.408869</td>
<td>   0</td>
<td>   103</td>
<td>      9</td>
</tr>
<tr>
<th>multihop.</th>
<td>  184.000000</td>
<td>  253.851006</td>
<td>   0</td>
<td>   718</td>
<td>      7</td>
</tr>
<tr>
<th>neptune.</th>
<td>    0.000000</td>
<td>    0.000000</td>
<td>   0</td>
<td>     0</td>
<td> 107201</td>
</tr>
<tr>
<th>nmap.</th>
<td>    0.000000</td>
<td>    0.000000</td>
<td>   0</td>
<td>     0</td>
<td>    231</td>
</tr>
<tr>
<th>normal.</th>
<td>  216.657322</td>
<td> 1359.213469</td>
<td>   0</td>
<td> 58329</td>
<td>  97278</td>
</tr>
<tr>
<th>perl.</th>
<td>   41.333333</td>
<td>   14.843629</td>
<td>  25</td>
<td>    54</td>
<td>      3</td>
</tr>
<tr>
<th>phf.</th>
<td>    4.500000</td>
<td>    5.744563</td>
<td>   0</td>
<td>    12</td>
<td>      4</td>
</tr>
<tr>
<th>pod.</th>
<td>    0.000000</td>
<td>    0.000000</td>
<td>   0</td>
<td>     0</td>
<td>    264</td>
</tr>
<tr>
<th>portsweep.</th>
<td> 1915.299038</td>
<td> 7285.125159</td>
<td>   0</td>
<td> 42448</td>
<td>   1040</td>
</tr>
<tr>
<th>rootkit.</th>
<td>  100.800000</td>
<td>  216.185003</td>
<td>   0</td>
<td>   708</td>
<td>     10</td>
</tr>
<tr>
<th>satan.</th>
<td>    0.040277</td>
<td>    0.522433</td>
<td>   0</td>
<td>    11</td>
<td>   1589</td>
</tr>
<tr>
<th>smurf.</th>
<td>    0.000000</td>
<td>    0.000000</td>
<td>   0</td>
<td>     0</td>
<td> 280790</td>
</tr>
<tr>
<th>spy.</th>
<td>  318.000000</td>
<td>   26.870058</td>
<td> 299</td>
<td>   337</td>
<td>      2</td>
</tr>
<tr>
<th>teardrop.</th>
<td>    0.000000</td>
<td>    0.000000</td>
<td>   0</td>
<td>     0</td>
<td>    979</td>
</tr>
<tr>
<th>warezclient.</th>
<td>  615.257843</td>
<td> 2207.694966</td>
<td>   0</td>
<td> 15168</td>
<td>   1020</td>
</tr>
<tr>
<th>warezmaster.</th>
<td>   15.050000</td>
<td>   33.385271</td>
<td>   0</td>
<td>   156</td>
<td>     20</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In order to reuse this code and get a dataframe from any variable in our dataset we will define a function.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [17]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_variable_stats_df</span><span class="p">(</span><span class="n">stats_by_label</span><span class="p">,</span> <span class="n">column_i</span><span class="p">):</span>
    <span class="n">column_stats_by_label</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()[</span><span class="n">column_i</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">variance</span><span class="p">()[</span><span class="n">column_i</span><span class="p">])),</span> <span class="nb">float</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()[</span><span class="n">column_i</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()[</span><span class="n">column_i</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">stat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">())]))</span> 
        <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">stats_by_label</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_items</span><span class="p">(</span><span class="n">column_stats_by_label</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"Mean"</span><span class="p">,</span> <span class="s2">"Std Dev"</span><span class="p">,</span> <span class="s2">"Min"</span><span class="p">,</span> <span class="s2">"Max"</span><span class="p">,</span> <span class="s2">"Count"</span><span class="p">],</span> <span class="n">orient</span><span class="o">=</span><span class="s1">'index'</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's try for <em>duration</em> again.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [18]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">get_variable_stats_df</span><span class="p">(</span><span class="n">stats_by_label</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[18]:</div>
<div class="output_html rendered_html output_subarea output_execute_result">
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>Mean</th>
<th>Std Dev</th>
<th>Min</th>
<th>Max</th>
<th>Count</th>
</tr>
</thead>
<tbody>
<tr>
<th>back.</th>
<td>    0.128915</td>
<td>    1.110062</td>
<td>   0</td>
<td>    14</td>
<td>   2203</td>
</tr>
<tr>
<th>buffer_overflow.</th>
<td>   91.700000</td>
<td>   97.514685</td>
<td>   0</td>
<td>   321</td>
<td>     30</td>
</tr>
<tr>
<th>ftp_write.</th>
<td>   32.375000</td>
<td>   47.449033</td>
<td>   0</td>
<td>   134</td>
<td>      8</td>
</tr>
<tr>
<th>guess_passwd.</th>
<td>    2.716981</td>
<td>   11.879811</td>
<td>   0</td>
<td>    60</td>
<td>     53</td>
</tr>
<tr>
<th>imap.</th>
<td>    6.000000</td>
<td>   14.174240</td>
<td>   0</td>
<td>    41</td>
<td>     12</td>
</tr>
<tr>
<th>ipsweep.</th>
<td>    0.034483</td>
<td>    0.438439</td>
<td>   0</td>
<td>     7</td>
<td>   1247</td>
</tr>
<tr>
<th>land.</th>
<td>    0.000000</td>
<td>    0.000000</td>
<td>   0</td>
<td>     0</td>
<td>     21</td>
</tr>
<tr>
<th>loadmodule.</th>
<td>   36.222222</td>
<td>   41.408869</td>
<td>   0</td>
<td>   103</td>
<td>      9</td>
</tr>
<tr>
<th>multihop.</th>
<td>  184.000000</td>
<td>  253.851006</td>
<td>   0</td>
<td>   718</td>
<td>      7</td>
</tr>
<tr>
<th>neptune.</th>
<td>    0.000000</td>
<td>    0.000000</td>
<td>   0</td>
<td>     0</td>
<td> 107201</td>
</tr>
<tr>
<th>nmap.</th>
<td>    0.000000</td>
<td>    0.000000</td>
<td>   0</td>
<td>     0</td>
<td>    231</td>
</tr>
<tr>
<th>normal.</th>
<td>  216.657322</td>
<td> 1359.213469</td>
<td>   0</td>
<td> 58329</td>
<td>  97278</td>
</tr>
<tr>
<th>perl.</th>
<td>   41.333333</td>
<td>   14.843629</td>
<td>  25</td>
<td>    54</td>
<td>      3</td>
</tr>
<tr>
<th>phf.</th>
<td>    4.500000</td>
<td>    5.744563</td>
<td>   0</td>
<td>    12</td>
<td>      4</td>
</tr>
<tr>
<th>pod.</th>
<td>    0.000000</td>
<td>    0.000000</td>
<td>   0</td>
<td>     0</td>
<td>    264</td>
</tr>
<tr>
<th>portsweep.</th>
<td> 1915.299038</td>
<td> 7285.125159</td>
<td>   0</td>
<td> 42448</td>
<td>   1040</td>
</tr>
<tr>
<th>rootkit.</th>
<td>  100.800000</td>
<td>  216.185003</td>
<td>   0</td>
<td>   708</td>
<td>     10</td>
</tr>
<tr>
<th>satan.</th>
<td>    0.040277</td>
<td>    0.522433</td>
<td>   0</td>
<td>    11</td>
<td>   1589</td>
</tr>
<tr>
<th>smurf.</th>
<td>    0.000000</td>
<td>    0.000000</td>
<td>   0</td>
<td>     0</td>
<td> 280790</td>
</tr>
<tr>
<th>spy.</th>
<td>  318.000000</td>
<td>   26.870058</td>
<td> 299</td>
<td>   337</td>
<td>      2</td>
</tr>
<tr>
<th>teardrop.</th>
<td>    0.000000</td>
<td>    0.000000</td>
<td>   0</td>
<td>     0</td>
<td>    979</td>
</tr>
<tr>
<th>warezclient.</th>
<td>  615.257843</td>
<td> 2207.694966</td>
<td>   0</td>
<td> 15168</td>
<td>   1020</td>
</tr>
<tr>
<th>warezmaster.</th>
<td>   15.050000</td>
<td>   33.385271</td>
<td>   0</td>
<td>   156</td>
<td>     20</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now for the next numeric column in the dataset, <em>src_bytes</em>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [19]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="nb">print</span> <span class="s2">"src_bytes statistics, by label"</span>
<span class="n">get_variable_stats_df</span><span class="p">(</span><span class="n">stats_by_label</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>src_bytes statistics, by label
</pre>
</div>
</div>
<div class="output_area">
<div class="prompt output_prompt">Out[19]:</div>
<div class="output_html rendered_html output_subarea output_execute_result">
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>Mean</th>
<th>Std Dev</th>
<th>Min</th>
<th>Max</th>
<th>Count</th>
</tr>
</thead>
<tbody>
<tr>
<th>back.</th>
<td>  54156.355878</td>
<td>     3159.360232</td>
<td> 13140</td>
<td>     54540</td>
<td>   2203</td>
</tr>
<tr>
<th>buffer_overflow.</th>
<td>   1400.433333</td>
<td>     1337.132616</td>
<td>     0</td>
<td>      6274</td>
<td>     30</td>
</tr>
<tr>
<th>ftp_write.</th>
<td>    220.750000</td>
<td>      267.747616</td>
<td>     0</td>
<td>       676</td>
<td>      8</td>
</tr>
<tr>
<th>guess_passwd.</th>
<td>    125.339623</td>
<td>        3.037860</td>
<td>   104</td>
<td>       126</td>
<td>     53</td>
</tr>
<tr>
<th>imap.</th>
<td>    347.583333</td>
<td>      629.926036</td>
<td>     0</td>
<td>      1492</td>
<td>     12</td>
</tr>
<tr>
<th>ipsweep.</th>
<td>     10.083400</td>
<td>        5.231658</td>
<td>     0</td>
<td>        18</td>
<td>   1247</td>
</tr>
<tr>
<th>land.</th>
<td>      0.000000</td>
<td>        0.000000</td>
<td>     0</td>
<td>         0</td>
<td>     21</td>
</tr>
<tr>
<th>loadmodule.</th>
<td>    151.888889</td>
<td>      127.745298</td>
<td>     0</td>
<td>       302</td>
<td>      9</td>
</tr>
<tr>
<th>multihop.</th>
<td>    435.142857</td>
<td>      540.960389</td>
<td>     0</td>
<td>      1412</td>
<td>      7</td>
</tr>
<tr>
<th>neptune.</th>
<td>      0.000000</td>
<td>        0.000000</td>
<td>     0</td>
<td>         0</td>
<td> 107201</td>
</tr>
<tr>
<th>nmap.</th>
<td>     24.116883</td>
<td>       59.419871</td>
<td>     0</td>
<td>       207</td>
<td>    231</td>
</tr>
<tr>
<th>normal.</th>
<td>   1157.047524</td>
<td>    34226.124718</td>
<td>     0</td>
<td>   2194619</td>
<td>  97278</td>
</tr>
<tr>
<th>perl.</th>
<td>    265.666667</td>
<td>        4.932883</td>
<td>   260</td>
<td>       269</td>
<td>      3</td>
</tr>
<tr>
<th>phf.</th>
<td>     51.000000</td>
<td>        0.000000</td>
<td>    51</td>
<td>        51</td>
<td>      4</td>
</tr>
<tr>
<th>pod.</th>
<td>   1462.651515</td>
<td>      125.098044</td>
<td>   564</td>
<td>      1480</td>
<td>    264</td>
</tr>
<tr>
<th>portsweep.</th>
<td> 666707.436538</td>
<td> 21500665.866700</td>
<td>     0</td>
<td> 693375640</td>
<td>   1040</td>
</tr>
<tr>
<th>rootkit.</th>
<td>    294.700000</td>
<td>      538.578180</td>
<td>     0</td>
<td>      1727</td>
<td>     10</td>
</tr>
<tr>
<th>satan.</th>
<td>      1.337319</td>
<td>       42.946200</td>
<td>     0</td>
<td>      1710</td>
<td>   1589</td>
</tr>
<tr>
<th>smurf.</th>
<td>    935.772300</td>
<td>      200.022386</td>
<td>   520</td>
<td>      1032</td>
<td> 280790</td>
</tr>
<tr>
<th>spy.</th>
<td>    174.500000</td>
<td>       88.388348</td>
<td>   112</td>
<td>       237</td>
<td>      2</td>
</tr>
<tr>
<th>teardrop.</th>
<td>     28.000000</td>
<td>        0.000000</td>
<td>    28</td>
<td>        28</td>
<td>    979</td>
</tr>
<tr>
<th>warezclient.</th>
<td> 300219.562745</td>
<td>  1200905.243130</td>
<td>    30</td>
<td>   5135678</td>
<td>   1020</td>
</tr>
<tr>
<th>warezmaster.</th>
<td>     49.300000</td>
<td>      212.155132</td>
<td>     0</td>
<td>       950</td>
<td>     20</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And so on. By reusing the <code>summary_by_label</code> and <code>get_variable_stats_df</code> functions we can perform some exploratory data analysis in large datasets with Spark.</p>
<h2 id="Correlations">Correlations<a class="anchor-link" href="#Correlations">¶</a></h2><p>Spark's MLlib supports <a href="http://en.wikipedia.org/wiki/Pearson_product-moment_correlation_coefficient">Pearson’s</a> and <a href="http://en.wikipedia.org/wiki/Spearman%27s_rank_correlation_coefficient">Spearman’s</a> to calculate pairwise correlation methods among many series. Both of them are provided by the <code>corr</code> method in the <code>Statistics</code> package.</p>
<p>We have two options as input. Either two <code>RDD[Double]</code>s or an <code>RDD[Vector]</code>. In the first case the output will be a <code>Double</code> value, while in the second a whole correlation Matrix. Due to the nature of our data, we will obtain the second.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [20]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.mllib.stat</span> <span class="k">import</span> <span class="n">Statistics</span> 
<span class="n">correlation_matrix</span> <span class="o">=</span> <span class="n">Statistics</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">vector_data</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">"spearman"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Once we have the correlations ready, we can start inspecting their values.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [21]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">'display.max_columns'</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">col_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"duration"</span><span class="p">,</span><span class="s2">"src_bytes"</span><span class="p">,</span><span class="s2">"dst_bytes"</span><span class="p">,</span><span class="s2">"land"</span><span class="p">,</span><span class="s2">"wrong_fragment"</span><span class="p">,</span>
             <span class="s2">"urgent"</span><span class="p">,</span><span class="s2">"hot"</span><span class="p">,</span><span class="s2">"num_failed_logins"</span><span class="p">,</span><span class="s2">"logged_in"</span><span class="p">,</span><span class="s2">"num_compromised"</span><span class="p">,</span>
             <span class="s2">"root_shell"</span><span class="p">,</span><span class="s2">"su_attempted"</span><span class="p">,</span><span class="s2">"num_root"</span><span class="p">,</span><span class="s2">"num_file_creations"</span><span class="p">,</span>
             <span class="s2">"num_shells"</span><span class="p">,</span><span class="s2">"num_access_files"</span><span class="p">,</span><span class="s2">"num_outbound_cmds"</span><span class="p">,</span>
             <span class="s2">"is_hot_login"</span><span class="p">,</span><span class="s2">"is_guest_login"</span><span class="p">,</span><span class="s2">"count"</span><span class="p">,</span><span class="s2">"srv_count"</span><span class="p">,</span><span class="s2">"serror_rate"</span><span class="p">,</span>
             <span class="s2">"srv_serror_rate"</span><span class="p">,</span><span class="s2">"rerror_rate"</span><span class="p">,</span><span class="s2">"srv_rerror_rate"</span><span class="p">,</span><span class="s2">"same_srv_rate"</span><span class="p">,</span>
             <span class="s2">"diff_srv_rate"</span><span class="p">,</span><span class="s2">"srv_diff_host_rate"</span><span class="p">,</span><span class="s2">"dst_host_count"</span><span class="p">,</span><span class="s2">"dst_host_srv_count"</span><span class="p">,</span>
             <span class="s2">"dst_host_same_srv_rate"</span><span class="p">,</span><span class="s2">"dst_host_diff_srv_rate"</span><span class="p">,</span><span class="s2">"dst_host_same_src_port_rate"</span><span class="p">,</span>
             <span class="s2">"dst_host_srv_diff_host_rate"</span><span class="p">,</span><span class="s2">"dst_host_serror_rate"</span><span class="p">,</span><span class="s2">"dst_host_srv_serror_rate"</span><span class="p">,</span>
             <span class="s2">"dst_host_rerror_rate"</span><span class="p">,</span><span class="s2">"dst_host_srv_rerror_rate"</span><span class="p">]</span>

<span class="n">corr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">correlation_matrix</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">col_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">col_names</span><span class="p">)</span>

<span class="n">corr_df</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[21]:</div>
<div class="output_html rendered_html output_subarea output_execute_result">
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>duration</th>
<th>src_bytes</th>
<th>dst_bytes</th>
<th>land</th>
<th>wrong_fragment</th>
<th>urgent</th>
<th>hot</th>
<th>num_failed_logins</th>
<th>logged_in</th>
<th>num_compromised</th>
<th>root_shell</th>
<th>su_attempted</th>
<th>num_root</th>
<th>num_file_creations</th>
<th>num_shells</th>
<th>num_access_files</th>
<th>num_outbound_cmds</th>
<th>is_hot_login</th>
<th>is_guest_login</th>
<th>count</th>
<th>srv_count</th>
<th>serror_rate</th>
<th>srv_serror_rate</th>
<th>rerror_rate</th>
<th>srv_rerror_rate</th>
<th>same_srv_rate</th>
<th>diff_srv_rate</th>
<th>srv_diff_host_rate</th>
<th>dst_host_count</th>
<th>dst_host_srv_count</th>
<th>dst_host_same_srv_rate</th>
<th>dst_host_diff_srv_rate</th>
<th>dst_host_same_src_port_rate</th>
<th>dst_host_srv_diff_host_rate</th>
<th>dst_host_serror_rate</th>
<th>dst_host_srv_serror_rate</th>
<th>dst_host_rerror_rate</th>
<th>dst_host_srv_rerror_rate</th>
</tr>
</thead>
<tbody>
<tr>
<th>duration</th>
<td> 1.000000</td>
<td> 0.014196</td>
<td> 0.299189</td>
<td>-0.001068</td>
<td>-0.008025</td>
<td> 0.017883</td>
<td> 0.108639</td>
<td> 0.014363</td>
<td> 0.159564</td>
<td> 0.010687</td>
<td> 0.040425</td>
<td> 0.026015</td>
<td> 0.013401</td>
<td> 0.061099</td>
<td> 0.008632</td>
<td> 0.019407</td>
<td>-0.000019</td>
<td>-0.000010</td>
<td> 0.205606</td>
<td>-0.259032</td>
<td>-0.250139</td>
<td>-0.074211</td>
<td>-0.073663</td>
<td>-0.025936</td>
<td>-0.026420</td>
<td> 0.062291</td>
<td>-0.050875</td>
<td> 0.123621</td>
<td>-0.161107</td>
<td>-0.217167</td>
<td>-0.211979</td>
<td> 0.231644</td>
<td>-0.065202</td>
<td> 0.100692</td>
<td>-0.056753</td>
<td>-0.057298</td>
<td>-0.007759</td>
<td>-0.013891</td>
</tr>
<tr>
<th>src_bytes</th>
<td> 0.014196</td>
<td> 1.000000</td>
<td>-0.167931</td>
<td>-0.009404</td>
<td>-0.019358</td>
<td> 0.000094</td>
<td> 0.113920</td>
<td>-0.008396</td>
<td>-0.089702</td>
<td> 0.118562</td>
<td> 0.003067</td>
<td> 0.002282</td>
<td>-0.002050</td>
<td> 0.027710</td>
<td> 0.014403</td>
<td>-0.001497</td>
<td> 0.000010</td>
<td> 0.000019</td>
<td> 0.027511</td>
<td> 0.666230</td>
<td> 0.722609</td>
<td>-0.657460</td>
<td>-0.652391</td>
<td>-0.342180</td>
<td>-0.332977</td>
<td> 0.744046</td>
<td>-0.739988</td>
<td>-0.104042</td>
<td> 0.130377</td>
<td> 0.741979</td>
<td> 0.729151</td>
<td>-0.712965</td>
<td> 0.815039</td>
<td>-0.140231</td>
<td>-0.645920</td>
<td>-0.641792</td>
<td>-0.297338</td>
<td>-0.300581</td>
</tr>
<tr>
<th>dst_bytes</th>
<td> 0.299189</td>
<td>-0.167931</td>
<td> 1.000000</td>
<td>-0.003040</td>
<td>-0.022659</td>
<td> 0.007234</td>
<td> 0.193156</td>
<td> 0.021952</td>
<td> 0.882185</td>
<td> 0.169772</td>
<td> 0.026054</td>
<td> 0.012192</td>
<td>-0.003884</td>
<td> 0.034154</td>
<td>-0.000054</td>
<td> 0.065776</td>
<td>-0.000031</td>
<td> 0.000041</td>
<td> 0.085947</td>
<td>-0.639157</td>
<td>-0.497683</td>
<td>-0.205848</td>
<td>-0.198715</td>
<td>-0.100958</td>
<td>-0.081307</td>
<td> 0.229677</td>
<td>-0.222572</td>
<td> 0.521003</td>
<td>-0.611972</td>
<td> 0.024124</td>
<td> 0.055033</td>
<td>-0.035073</td>
<td>-0.396195</td>
<td> 0.578557</td>
<td>-0.167047</td>
<td>-0.158378</td>
<td>-0.003042</td>
<td> 0.001621</td>
</tr>
<tr>
<th>land</th>
<td>-0.001068</td>
<td>-0.009404</td>
<td>-0.003040</td>
<td> 1.000000</td>
<td>-0.000333</td>
<td>-0.000065</td>
<td>-0.000539</td>
<td>-0.000076</td>
<td>-0.002785</td>
<td>-0.000447</td>
<td>-0.000093</td>
<td>-0.000049</td>
<td>-0.000230</td>
<td>-0.000150</td>
<td>-0.000076</td>
<td>-0.000211</td>
<td>-0.002881</td>
<td> 0.002089</td>
<td>-0.000250</td>
<td>-0.010939</td>
<td>-0.010128</td>
<td> 0.014160</td>
<td> 0.014342</td>
<td>-0.000451</td>
<td>-0.001690</td>
<td> 0.002153</td>
<td>-0.001846</td>
<td> 0.020678</td>
<td>-0.019923</td>
<td>-0.012341</td>
<td> 0.002576</td>
<td>-0.001803</td>
<td> 0.004265</td>
<td> 0.016171</td>
<td> 0.013566</td>
<td> 0.012265</td>
<td> 0.000389</td>
<td>-0.001816</td>
</tr>
<tr>
<th>wrong_fragment</th>
<td>-0.008025</td>
<td>-0.019358</td>
<td>-0.022659</td>
<td>-0.000333</td>
<td> 1.000000</td>
<td>-0.000150</td>
<td>-0.004042</td>
<td>-0.000568</td>
<td>-0.020911</td>
<td>-0.003370</td>
<td>-0.000528</td>
<td>-0.000248</td>
<td>-0.001727</td>
<td>-0.001160</td>
<td>-0.000507</td>
<td>-0.001519</td>
<td>-0.000147</td>
<td> 0.000441</td>
<td>-0.001869</td>
<td>-0.057711</td>
<td>-0.029117</td>
<td>-0.008849</td>
<td>-0.023382</td>
<td> 0.000430</td>
<td>-0.012676</td>
<td> 0.010218</td>
<td>-0.009386</td>
<td> 0.012117</td>
<td>-0.029149</td>
<td>-0.058225</td>
<td>-0.049560</td>
<td> 0.055542</td>
<td>-0.015449</td>
<td> 0.007306</td>
<td> 0.010387</td>
<td>-0.024117</td>
<td> 0.046656</td>
<td>-0.013666</td>
</tr>
<tr>
<th>urgent</th>
<td> 0.017883</td>
<td> 0.000094</td>
<td> 0.007234</td>
<td>-0.000065</td>
<td>-0.000150</td>
<td> 1.000000</td>
<td> 0.008594</td>
<td> 0.063009</td>
<td> 0.006821</td>
<td> 0.031765</td>
<td> 0.067437</td>
<td> 0.000020</td>
<td> 0.061994</td>
<td> 0.061383</td>
<td>-0.000066</td>
<td> 0.023380</td>
<td> 0.012879</td>
<td> 0.005162</td>
<td>-0.000100</td>
<td>-0.004778</td>
<td>-0.004799</td>
<td>-0.001338</td>
<td>-0.001327</td>
<td>-0.000705</td>
<td>-0.000726</td>
<td> 0.001521</td>
<td>-0.001522</td>
<td>-0.000788</td>
<td>-0.005894</td>
<td>-0.005698</td>
<td>-0.004078</td>
<td> 0.005208</td>
<td>-0.001939</td>
<td>-0.000976</td>
<td>-0.001381</td>
<td>-0.001370</td>
<td>-0.000786</td>
<td>-0.000782</td>
</tr>
<tr>
<th>hot</th>
<td> 0.108639</td>
<td> 0.113920</td>
<td> 0.193156</td>
<td>-0.000539</td>
<td>-0.004042</td>
<td> 0.008594</td>
<td> 1.000000</td>
<td> 0.112560</td>
<td> 0.189126</td>
<td> 0.811529</td>
<td> 0.101983</td>
<td>-0.000400</td>
<td> 0.003096</td>
<td> 0.028694</td>
<td> 0.009146</td>
<td> 0.004224</td>
<td>-0.000393</td>
<td>-0.000248</td>
<td> 0.463706</td>
<td>-0.120847</td>
<td>-0.114735</td>
<td>-0.035487</td>
<td>-0.034934</td>
<td> 0.013468</td>
<td> 0.052003</td>
<td> 0.041342</td>
<td>-0.040555</td>
<td> 0.032141</td>
<td>-0.074178</td>
<td>-0.017960</td>
<td> 0.018783</td>
<td>-0.017198</td>
<td>-0.086998</td>
<td>-0.014141</td>
<td>-0.004706</td>
<td>-0.010721</td>
<td> 0.199019</td>
<td> 0.189142</td>
</tr>
<tr>
<th>num_failed_logins</th>
<td> 0.014363</td>
<td>-0.008396</td>
<td> 0.021952</td>
<td>-0.000076</td>
<td>-0.000568</td>
<td> 0.063009</td>
<td> 0.112560</td>
<td> 1.000000</td>
<td>-0.002190</td>
<td> 0.004619</td>
<td> 0.016895</td>
<td> 0.072748</td>
<td> 0.010060</td>
<td> 0.015211</td>
<td>-0.000093</td>
<td> 0.005581</td>
<td> 0.003431</td>
<td>-0.001560</td>
<td>-0.000428</td>
<td>-0.018024</td>
<td>-0.018027</td>
<td>-0.003674</td>
<td>-0.004027</td>
<td> 0.035324</td>
<td> 0.034876</td>
<td> 0.005716</td>
<td>-0.005538</td>
<td>-0.003096</td>
<td>-0.028369</td>
<td>-0.015092</td>
<td> 0.003004</td>
<td>-0.002960</td>
<td>-0.006617</td>
<td>-0.002588</td>
<td> 0.014713</td>
<td> 0.014914</td>
<td> 0.032395</td>
<td> 0.032151</td>
</tr>
<tr>
<th>logged_in</th>
<td> 0.159564</td>
<td>-0.089702</td>
<td> 0.882185</td>
<td>-0.002785</td>
<td>-0.020911</td>
<td> 0.006821</td>
<td> 0.189126</td>
<td>-0.002190</td>
<td> 1.000000</td>
<td> 0.161190</td>
<td> 0.025293</td>
<td> 0.011813</td>
<td> 0.082533</td>
<td> 0.055530</td>
<td> 0.024354</td>
<td> 0.072698</td>
<td> 0.000079</td>
<td> 0.000127</td>
<td> 0.089318</td>
<td>-0.578287</td>
<td>-0.438947</td>
<td>-0.187114</td>
<td>-0.180122</td>
<td>-0.091962</td>
<td>-0.072287</td>
<td> 0.216969</td>
<td>-0.214019</td>
<td> 0.503807</td>
<td>-0.682721</td>
<td> 0.080352</td>
<td> 0.114526</td>
<td>-0.093565</td>
<td>-0.359506</td>
<td> 0.659078</td>
<td>-0.143283</td>
<td>-0.132474</td>
<td> 0.007236</td>
<td> 0.012979</td>
</tr>
<tr>
<th>num_compromised</th>
<td> 0.010687</td>
<td> 0.118562</td>
<td> 0.169772</td>
<td>-0.000447</td>
<td>-0.003370</td>
<td> 0.031765</td>
<td> 0.811529</td>
<td> 0.004619</td>
<td> 0.161190</td>
<td> 1.000000</td>
<td> 0.085558</td>
<td> 0.048985</td>
<td> 0.028557</td>
<td> 0.031223</td>
<td> 0.011256</td>
<td> 0.006977</td>
<td> 0.001048</td>
<td>-0.000438</td>
<td>-0.002504</td>
<td>-0.097212</td>
<td>-0.091154</td>
<td>-0.030516</td>
<td>-0.030264</td>
<td> 0.008573</td>
<td> 0.054006</td>
<td> 0.035253</td>
<td>-0.034953</td>
<td> 0.036497</td>
<td>-0.041615</td>
<td> 0.003465</td>
<td> 0.038980</td>
<td>-0.039091</td>
<td>-0.078843</td>
<td>-0.020979</td>
<td>-0.005019</td>
<td>-0.004504</td>
<td> 0.214115</td>
<td> 0.217858</td>
</tr>
<tr>
<th>root_shell</th>
<td> 0.040425</td>
<td> 0.003067</td>
<td> 0.026054</td>
<td>-0.000093</td>
<td>-0.000528</td>
<td> 0.067437</td>
<td> 0.101983</td>
<td> 0.016895</td>
<td> 0.025293</td>
<td> 0.085558</td>
<td> 1.000000</td>
<td> 0.233486</td>
<td> 0.094512</td>
<td> 0.140650</td>
<td> 0.132056</td>
<td> 0.069353</td>
<td> 0.011462</td>
<td>-0.006602</td>
<td>-0.000405</td>
<td>-0.016409</td>
<td>-0.015174</td>
<td>-0.004952</td>
<td>-0.004923</td>
<td>-0.001104</td>
<td>-0.001143</td>
<td> 0.004946</td>
<td>-0.004553</td>
<td> 0.002286</td>
<td>-0.021367</td>
<td>-0.011906</td>
<td> 0.000515</td>
<td>-0.000916</td>
<td>-0.004617</td>
<td> 0.008631</td>
<td>-0.003498</td>
<td>-0.003032</td>
<td> 0.002763</td>
<td> 0.002151</td>
</tr>
<tr>
<th>su_attempted</th>
<td> 0.026015</td>
<td> 0.002282</td>
<td> 0.012192</td>
<td>-0.000049</td>
<td>-0.000248</td>
<td> 0.000020</td>
<td>-0.000400</td>
<td> 0.072748</td>
<td> 0.011813</td>
<td> 0.048985</td>
<td> 0.233486</td>
<td> 1.000000</td>
<td> 0.119326</td>
<td> 0.053110</td>
<td> 0.040487</td>
<td> 0.081272</td>
<td>-0.018896</td>
<td> 0.012927</td>
<td>-0.000219</td>
<td>-0.008279</td>
<td>-0.008225</td>
<td>-0.002318</td>
<td>-0.002295</td>
<td>-0.001227</td>
<td>-0.001253</td>
<td> 0.002634</td>
<td>-0.002649</td>
<td> 0.000348</td>
<td>-0.006697</td>
<td>-0.006288</td>
<td>-0.005738</td>
<td> 0.006687</td>
<td>-0.005020</td>
<td> 0.001052</td>
<td> 0.001974</td>
<td> 0.002893</td>
<td> 0.003173</td>
<td> 0.001731</td>
</tr>
<tr>
<th>num_root</th>
<td> 0.013401</td>
<td>-0.002050</td>
<td>-0.003884</td>
<td>-0.000230</td>
<td>-0.001727</td>
<td> 0.061994</td>
<td> 0.003096</td>
<td> 0.010060</td>
<td> 0.082533</td>
<td> 0.028557</td>
<td> 0.094512</td>
<td> 0.119326</td>
<td> 1.000000</td>
<td> 0.047521</td>
<td> 0.034405</td>
<td> 0.014513</td>
<td> 0.001524</td>
<td>-0.002585</td>
<td>-0.001281</td>
<td>-0.054721</td>
<td>-0.053530</td>
<td>-0.016031</td>
<td>-0.015936</td>
<td>-0.008610</td>
<td>-0.008708</td>
<td> 0.013881</td>
<td>-0.011337</td>
<td> 0.006316</td>
<td>-0.078717</td>
<td>-0.038689</td>
<td>-0.038935</td>
<td> 0.047414</td>
<td>-0.015968</td>
<td> 0.061030</td>
<td>-0.008457</td>
<td>-0.007096</td>
<td>-0.000421</td>
<td>-0.005012</td>
</tr>
<tr>
<th>num_file_creations</th>
<td> 0.061099</td>
<td> 0.027710</td>
<td> 0.034154</td>
<td>-0.000150</td>
<td>-0.001160</td>
<td> 0.061383</td>
<td> 0.028694</td>
<td> 0.015211</td>
<td> 0.055530</td>
<td> 0.031223</td>
<td> 0.140650</td>
<td> 0.053110</td>
<td> 0.047521</td>
<td> 1.000000</td>
<td> 0.068660</td>
<td> 0.031042</td>
<td>-0.004081</td>
<td>-0.001664</td>
<td> 0.013242</td>
<td>-0.036467</td>
<td>-0.034598</td>
<td>-0.009703</td>
<td>-0.010390</td>
<td>-0.005069</td>
<td>-0.004775</td>
<td> 0.009784</td>
<td>-0.008711</td>
<td> 0.014412</td>
<td>-0.049529</td>
<td>-0.026890</td>
<td>-0.021731</td>
<td> 0.027092</td>
<td>-0.015018</td>
<td> 0.030590</td>
<td>-0.002257</td>
<td>-0.004295</td>
<td> 0.000626</td>
<td>-0.001096</td>
</tr>
<tr>
<th>num_shells</th>
<td> 0.008632</td>
<td> 0.014403</td>
<td>-0.000054</td>
<td>-0.000076</td>
<td>-0.000507</td>
<td>-0.000066</td>
<td> 0.009146</td>
<td>-0.000093</td>
<td> 0.024354</td>
<td> 0.011256</td>
<td> 0.132056</td>
<td> 0.040487</td>
<td> 0.034405</td>
<td> 0.068660</td>
<td> 1.000000</td>
<td> 0.019438</td>
<td>-0.002592</td>
<td>-0.006631</td>
<td>-0.000405</td>
<td>-0.013938</td>
<td>-0.011784</td>
<td>-0.004343</td>
<td>-0.004740</td>
<td>-0.002541</td>
<td>-0.002572</td>
<td> 0.004282</td>
<td>-0.003743</td>
<td> 0.001096</td>
<td>-0.021200</td>
<td>-0.012017</td>
<td>-0.009962</td>
<td> 0.010761</td>
<td>-0.003521</td>
<td> 0.015882</td>
<td>-0.001588</td>
<td>-0.002357</td>
<td>-0.000617</td>
<td>-0.002020</td>
</tr>
<tr>
<th>num_access_files</th>
<td> 0.019407</td>
<td>-0.001497</td>
<td> 0.065776</td>
<td>-0.000211</td>
<td>-0.001519</td>
<td> 0.023380</td>
<td> 0.004224</td>
<td> 0.005581</td>
<td> 0.072698</td>
<td> 0.006977</td>
<td> 0.069353</td>
<td> 0.081272</td>
<td> 0.014513</td>
<td> 0.031042</td>
<td> 0.019438</td>
<td> 1.000000</td>
<td>-0.001597</td>
<td>-0.002850</td>
<td> 0.002466</td>
<td>-0.045282</td>
<td>-0.040497</td>
<td>-0.013945</td>
<td>-0.013572</td>
<td>-0.007581</td>
<td> 0.001874</td>
<td> 0.015499</td>
<td>-0.015112</td>
<td> 0.024266</td>
<td>-0.023865</td>
<td>-0.023657</td>
<td>-0.021358</td>
<td> 0.026703</td>
<td>-0.033288</td>
<td> 0.011765</td>
<td>-0.011197</td>
<td>-0.011487</td>
<td>-0.004743</td>
<td>-0.004552</td>
</tr>
<tr>
<th>num_outbound_cmds</th>
<td>-0.000019</td>
<td> 0.000010</td>
<td>-0.000031</td>
<td>-0.002881</td>
<td>-0.000147</td>
<td> 0.012879</td>
<td>-0.000393</td>
<td> 0.003431</td>
<td> 0.000079</td>
<td> 0.001048</td>
<td> 0.011462</td>
<td>-0.018896</td>
<td> 0.001524</td>
<td>-0.004081</td>
<td>-0.002592</td>
<td>-0.001597</td>
<td> 1.000000</td>
<td> 0.822890</td>
<td> 0.000924</td>
<td>-0.000076</td>
<td> 0.000100</td>
<td> 0.000167</td>
<td> 0.000209</td>
<td> 0.000536</td>
<td> 0.000346</td>
<td> 0.000208</td>
<td> 0.000328</td>
<td>-0.000141</td>
<td>-0.000424</td>
<td>-0.000280</td>
<td>-0.000503</td>
<td>-0.000181</td>
<td>-0.000455</td>
<td> 0.000288</td>
<td>-0.000011</td>
<td>-0.000372</td>
<td>-0.000823</td>
<td>-0.001038</td>
</tr>
<tr>
<th>is_hot_login</th>
<td>-0.000010</td>
<td> 0.000019</td>
<td> 0.000041</td>
<td> 0.002089</td>
<td> 0.000441</td>
<td> 0.005162</td>
<td>-0.000248</td>
<td>-0.001560</td>
<td> 0.000127</td>
<td>-0.000438</td>
<td>-0.006602</td>
<td> 0.012927</td>
<td>-0.002585</td>
<td>-0.001664</td>
<td>-0.006631</td>
<td>-0.002850</td>
<td> 0.822890</td>
<td> 1.000000</td>
<td> 0.001512</td>
<td> 0.000036</td>
<td> 0.000064</td>
<td> 0.000102</td>
<td>-0.000302</td>
<td>-0.000550</td>
<td> 0.000457</td>
<td>-0.000159</td>
<td>-0.000235</td>
<td>-0.000360</td>
<td>-0.000106</td>
<td> 0.000206</td>
<td> 0.000229</td>
<td>-0.000004</td>
<td> 0.000283</td>
<td> 0.000538</td>
<td>-0.000076</td>
<td>-0.000007</td>
<td>-0.000435</td>
<td>-0.000529</td>
</tr>
<tr>
<th>is_guest_login</th>
<td> 0.205606</td>
<td> 0.027511</td>
<td> 0.085947</td>
<td>-0.000250</td>
<td>-0.001869</td>
<td>-0.000100</td>
<td> 0.463706</td>
<td>-0.000428</td>
<td> 0.089318</td>
<td>-0.002504</td>
<td>-0.000405</td>
<td>-0.000219</td>
<td>-0.001281</td>
<td> 0.013242</td>
<td>-0.000405</td>
<td> 0.002466</td>
<td> 0.000924</td>
<td> 0.001512</td>
<td> 1.000000</td>
<td>-0.062340</td>
<td>-0.062713</td>
<td>-0.017343</td>
<td>-0.017240</td>
<td>-0.008867</td>
<td>-0.009193</td>
<td> 0.018042</td>
<td>-0.017000</td>
<td>-0.008878</td>
<td>-0.055453</td>
<td>-0.044366</td>
<td>-0.041749</td>
<td> 0.044640</td>
<td>-0.038092</td>
<td>-0.012578</td>
<td>-0.001066</td>
<td>-0.016885</td>
<td> 0.025282</td>
<td>-0.004292</td>
</tr>
<tr>
<th>count</th>
<td>-0.259032</td>
<td> 0.666230</td>
<td>-0.639157</td>
<td>-0.010939</td>
<td>-0.057711</td>
<td>-0.004778</td>
<td>-0.120847</td>
<td>-0.018024</td>
<td>-0.578287</td>
<td>-0.097212</td>
<td>-0.016409</td>
<td>-0.008279</td>
<td>-0.054721</td>
<td>-0.036467</td>
<td>-0.013938</td>
<td>-0.045282</td>
<td>-0.000076</td>
<td> 0.000036</td>
<td>-0.062340</td>
<td> 1.000000</td>
<td> 0.950587</td>
<td>-0.303538</td>
<td>-0.308923</td>
<td>-0.213824</td>
<td>-0.221352</td>
<td> 0.346718</td>
<td>-0.361737</td>
<td>-0.384010</td>
<td> 0.547443</td>
<td> 0.586979</td>
<td> 0.539698</td>
<td>-0.546869</td>
<td> 0.776906</td>
<td>-0.496554</td>
<td>-0.331571</td>
<td>-0.335290</td>
<td>-0.261194</td>
<td>-0.256176</td>
</tr>
<tr>
<th>srv_count</th>
<td>-0.250139</td>
<td> 0.722609</td>
<td>-0.497683</td>
<td>-0.010128</td>
<td>-0.029117</td>
<td>-0.004799</td>
<td>-0.114735</td>
<td>-0.018027</td>
<td>-0.438947</td>
<td>-0.091154</td>
<td>-0.015174</td>
<td>-0.008225</td>
<td>-0.053530</td>
<td>-0.034598</td>
<td>-0.011784</td>
<td>-0.040497</td>
<td> 0.000100</td>
<td> 0.000064</td>
<td>-0.062713</td>
<td> 0.950587</td>
<td> 1.000000</td>
<td>-0.428185</td>
<td>-0.421424</td>
<td>-0.281468</td>
<td>-0.284034</td>
<td> 0.517227</td>
<td>-0.511998</td>
<td>-0.239057</td>
<td> 0.442611</td>
<td> 0.720746</td>
<td> 0.681955</td>
<td>-0.673916</td>
<td> 0.812280</td>
<td>-0.391712</td>
<td>-0.449096</td>
<td>-0.442823</td>
<td>-0.313442</td>
<td>-0.308132</td>
</tr>
<tr>
<th>serror_rate</th>
<td>-0.074211</td>
<td>-0.657460</td>
<td>-0.205848</td>
<td> 0.014160</td>
<td>-0.008849</td>
<td>-0.001338</td>
<td>-0.035487</td>
<td>-0.003674</td>
<td>-0.187114</td>
<td>-0.030516</td>
<td>-0.004952</td>
<td>-0.002318</td>
<td>-0.016031</td>
<td>-0.009703</td>
<td>-0.004343</td>
<td>-0.013945</td>
<td> 0.000167</td>
<td> 0.000102</td>
<td>-0.017343</td>
<td>-0.303538</td>
<td>-0.428185</td>
<td> 1.000000</td>
<td> 0.990888</td>
<td>-0.091157</td>
<td>-0.095285</td>
<td>-0.851915</td>
<td> 0.828012</td>
<td>-0.121489</td>
<td> 0.165350</td>
<td>-0.724317</td>
<td>-0.745745</td>
<td> 0.719708</td>
<td>-0.650336</td>
<td>-0.153568</td>
<td> 0.973947</td>
<td> 0.965663</td>
<td>-0.103198</td>
<td>-0.105434</td>
</tr>
<tr>
<th>srv_serror_rate</th>
<td>-0.073663</td>
<td>-0.652391</td>
<td>-0.198715</td>
<td> 0.014342</td>
<td>-0.023382</td>
<td>-0.001327</td>
<td>-0.034934</td>
<td>-0.004027</td>
<td>-0.180122</td>
<td>-0.030264</td>
<td>-0.004923</td>
<td>-0.002295</td>
<td>-0.015936</td>
<td>-0.010390</td>
<td>-0.004740</td>
<td>-0.013572</td>
<td> 0.000209</td>
<td>-0.000302</td>
<td>-0.017240</td>
<td>-0.308923</td>
<td>-0.421424</td>
<td> 0.990888</td>
<td> 1.000000</td>
<td>-0.110664</td>
<td>-0.115286</td>
<td>-0.839315</td>
<td> 0.815305</td>
<td>-0.112222</td>
<td> 0.160322</td>
<td>-0.713313</td>
<td>-0.734334</td>
<td> 0.707753</td>
<td>-0.646256</td>
<td>-0.148072</td>
<td> 0.967214</td>
<td> 0.970617</td>
<td>-0.122630</td>
<td>-0.124656</td>
</tr>
<tr>
<th>rerror_rate</th>
<td>-0.025936</td>
<td>-0.342180</td>
<td>-0.100958</td>
<td>-0.000451</td>
<td> 0.000430</td>
<td>-0.000705</td>
<td> 0.013468</td>
<td> 0.035324</td>
<td>-0.091962</td>
<td> 0.008573</td>
<td>-0.001104</td>
<td>-0.001227</td>
<td>-0.008610</td>
<td>-0.005069</td>
<td>-0.002541</td>
<td>-0.007581</td>
<td> 0.000536</td>
<td>-0.000550</td>
<td>-0.008867</td>
<td>-0.213824</td>
<td>-0.281468</td>
<td>-0.091157</td>
<td>-0.110664</td>
<td> 1.000000</td>
<td> 0.978813</td>
<td>-0.327986</td>
<td> 0.345571</td>
<td>-0.017902</td>
<td>-0.067857</td>
<td>-0.330391</td>
<td>-0.303126</td>
<td> 0.308722</td>
<td>-0.278465</td>
<td> 0.073061</td>
<td>-0.094076</td>
<td>-0.110646</td>
<td> 0.910225</td>
<td> 0.911622</td>
</tr>
<tr>
<th>srv_rerror_rate</th>
<td>-0.026420</td>
<td>-0.332977</td>
<td>-0.081307</td>
<td>-0.001690</td>
<td>-0.012676</td>
<td>-0.000726</td>
<td> 0.052003</td>
<td> 0.034876</td>
<td>-0.072287</td>
<td> 0.054006</td>
<td>-0.001143</td>
<td>-0.001253</td>
<td>-0.008708</td>
<td>-0.004775</td>
<td>-0.002572</td>
<td> 0.001874</td>
<td> 0.000346</td>
<td> 0.000457</td>
<td>-0.009193</td>
<td>-0.221352</td>
<td>-0.284034</td>
<td>-0.095285</td>
<td>-0.115286</td>
<td> 0.978813</td>
<td> 1.000000</td>
<td>-0.316568</td>
<td> 0.333439</td>
<td> 0.011285</td>
<td>-0.072595</td>
<td>-0.323032</td>
<td>-0.294328</td>
<td> 0.300186</td>
<td>-0.282239</td>
<td> 0.075178</td>
<td>-0.096146</td>
<td>-0.114341</td>
<td> 0.904591</td>
<td> 0.914904</td>
</tr>
<tr>
<th>same_srv_rate</th>
<td> 0.062291</td>
<td> 0.744046</td>
<td> 0.229677</td>
<td> 0.002153</td>
<td> 0.010218</td>
<td> 0.001521</td>
<td> 0.041342</td>
<td> 0.005716</td>
<td> 0.216969</td>
<td> 0.035253</td>
<td> 0.004946</td>
<td> 0.002634</td>
<td> 0.013881</td>
<td> 0.009784</td>
<td> 0.004282</td>
<td> 0.015499</td>
<td> 0.000208</td>
<td>-0.000159</td>
<td> 0.018042</td>
<td> 0.346718</td>
<td> 0.517227</td>
<td>-0.851915</td>
<td>-0.839315</td>
<td>-0.327986</td>
<td>-0.316568</td>
<td> 1.000000</td>
<td>-0.982109</td>
<td> 0.140660</td>
<td>-0.190121</td>
<td> 0.848754</td>
<td> 0.873551</td>
<td>-0.844537</td>
<td> 0.732841</td>
<td> 0.179040</td>
<td>-0.830067</td>
<td>-0.819335</td>
<td>-0.282487</td>
<td>-0.282913</td>
</tr>
<tr>
<th>diff_srv_rate</th>
<td>-0.050875</td>
<td>-0.739988</td>
<td>-0.222572</td>
<td>-0.001846</td>
<td>-0.009386</td>
<td>-0.001522</td>
<td>-0.040555</td>
<td>-0.005538</td>
<td>-0.214019</td>
<td>-0.034953</td>
<td>-0.004553</td>
<td>-0.002649</td>
<td>-0.011337</td>
<td>-0.008711</td>
<td>-0.003743</td>
<td>-0.015112</td>
<td> 0.000328</td>
<td>-0.000235</td>
<td>-0.017000</td>
<td>-0.361737</td>
<td>-0.511998</td>
<td> 0.828012</td>
<td> 0.815305</td>
<td> 0.345571</td>
<td> 0.333439</td>
<td>-0.982109</td>
<td> 1.000000</td>
<td>-0.138293</td>
<td> 0.185942</td>
<td>-0.844028</td>
<td>-0.868580</td>
<td> 0.850911</td>
<td>-0.727031</td>
<td>-0.176930</td>
<td> 0.807205</td>
<td> 0.795844</td>
<td> 0.299041</td>
<td> 0.298904</td>
</tr>
<tr>
<th>srv_diff_host_rate</th>
<td> 0.123621</td>
<td>-0.104042</td>
<td> 0.521003</td>
<td> 0.020678</td>
<td> 0.012117</td>
<td>-0.000788</td>
<td> 0.032141</td>
<td>-0.003096</td>
<td> 0.503807</td>
<td> 0.036497</td>
<td> 0.002286</td>
<td> 0.000348</td>
<td> 0.006316</td>
<td> 0.014412</td>
<td> 0.001096</td>
<td> 0.024266</td>
<td>-0.000141</td>
<td>-0.000360</td>
<td>-0.008878</td>
<td>-0.384010</td>
<td>-0.239057</td>
<td>-0.121489</td>
<td>-0.112222</td>
<td>-0.017902</td>
<td> 0.011285</td>
<td> 0.140660</td>
<td>-0.138293</td>
<td> 1.000000</td>
<td>-0.445051</td>
<td> 0.035010</td>
<td> 0.068648</td>
<td>-0.050472</td>
<td>-0.222707</td>
<td> 0.433173</td>
<td>-0.097973</td>
<td>-0.092661</td>
<td> 0.022585</td>
<td> 0.024722</td>
</tr>
<tr>
<th>dst_host_count</th>
<td>-0.161107</td>
<td> 0.130377</td>
<td>-0.611972</td>
<td>-0.019923</td>
<td>-0.029149</td>
<td>-0.005894</td>
<td>-0.074178</td>
<td>-0.028369</td>
<td>-0.682721</td>
<td>-0.041615</td>
<td>-0.021367</td>
<td>-0.006697</td>
<td>-0.078717</td>
<td>-0.049529</td>
<td>-0.021200</td>
<td>-0.023865</td>
<td>-0.000424</td>
<td>-0.000106</td>
<td>-0.055453</td>
<td> 0.547443</td>
<td> 0.442611</td>
<td> 0.165350</td>
<td> 0.160322</td>
<td>-0.067857</td>
<td>-0.072595</td>
<td>-0.190121</td>
<td> 0.185942</td>
<td>-0.445051</td>
<td> 1.000000</td>
<td> 0.022731</td>
<td>-0.070448</td>
<td> 0.044338</td>
<td> 0.189876</td>
<td>-0.918894</td>
<td> 0.123881</td>
<td> 0.113845</td>
<td>-0.125142</td>
<td>-0.125273</td>
</tr>
<tr>
<th>dst_host_srv_count</th>
<td>-0.217167</td>
<td> 0.741979</td>
<td> 0.024124</td>
<td>-0.012341</td>
<td>-0.058225</td>
<td>-0.005698</td>
<td>-0.017960</td>
<td>-0.015092</td>
<td> 0.080352</td>
<td> 0.003465</td>
<td>-0.011906</td>
<td>-0.006288</td>
<td>-0.038689</td>
<td>-0.026890</td>
<td>-0.012017</td>
<td>-0.023657</td>
<td>-0.000280</td>
<td> 0.000206</td>
<td>-0.044366</td>
<td> 0.586979</td>
<td> 0.720746</td>
<td>-0.724317</td>
<td>-0.713313</td>
<td>-0.330391</td>
<td>-0.323032</td>
<td> 0.848754</td>
<td>-0.844028</td>
<td> 0.035010</td>
<td> 0.022731</td>
<td> 1.000000</td>
<td> 0.970072</td>
<td>-0.955178</td>
<td> 0.769481</td>
<td> 0.043668</td>
<td>-0.722607</td>
<td>-0.708392</td>
<td>-0.312040</td>
<td>-0.300787</td>
</tr>
<tr>
<th>dst_host_same_srv_rate</th>
<td>-0.211979</td>
<td> 0.729151</td>
<td> 0.055033</td>
<td> 0.002576</td>
<td>-0.049560</td>
<td>-0.004078</td>
<td> 0.018783</td>
<td> 0.003004</td>
<td> 0.114526</td>
<td> 0.038980</td>
<td> 0.000515</td>
<td>-0.005738</td>
<td>-0.038935</td>
<td>-0.021731</td>
<td>-0.009962</td>
<td>-0.021358</td>
<td>-0.000503</td>
<td> 0.000229</td>
<td>-0.041749</td>
<td> 0.539698</td>
<td> 0.681955</td>
<td>-0.745745</td>
<td>-0.734334</td>
<td>-0.303126</td>
<td>-0.294328</td>
<td> 0.873551</td>
<td>-0.868580</td>
<td> 0.068648</td>
<td>-0.070448</td>
<td> 0.970072</td>
<td> 1.000000</td>
<td>-0.980245</td>
<td> 0.771158</td>
<td> 0.107926</td>
<td>-0.742045</td>
<td>-0.725272</td>
<td>-0.278068</td>
<td>-0.264383</td>
</tr>
<tr>
<th>dst_host_diff_srv_rate</th>
<td> 0.231644</td>
<td>-0.712965</td>
<td>-0.035073</td>
<td>-0.001803</td>
<td> 0.055542</td>
<td> 0.005208</td>
<td>-0.017198</td>
<td>-0.002960</td>
<td>-0.093565</td>
<td>-0.039091</td>
<td>-0.000916</td>
<td> 0.006687</td>
<td> 0.047414</td>
<td> 0.027092</td>
<td> 0.010761</td>
<td> 0.026703</td>
<td>-0.000181</td>
<td>-0.000004</td>
<td> 0.044640</td>
<td>-0.546869</td>
<td>-0.673916</td>
<td> 0.719708</td>
<td> 0.707753</td>
<td> 0.308722</td>
<td> 0.300186</td>
<td>-0.844537</td>
<td> 0.850911</td>
<td>-0.050472</td>
<td> 0.044338</td>
<td>-0.955178</td>
<td>-0.980245</td>
<td> 1.000000</td>
<td>-0.766402</td>
<td>-0.088665</td>
<td> 0.719275</td>
<td> 0.701149</td>
<td> 0.287476</td>
<td> 0.271067</td>
</tr>
<tr>
<th>dst_host_same_src_port_rate</th>
<td>-0.065202</td>
<td> 0.815039</td>
<td>-0.396195</td>
<td> 0.004265</td>
<td>-0.015449</td>
<td>-0.001939</td>
<td>-0.086998</td>
<td>-0.006617</td>
<td>-0.359506</td>
<td>-0.078843</td>
<td>-0.004617</td>
<td>-0.005020</td>
<td>-0.015968</td>
<td>-0.015018</td>
<td>-0.003521</td>
<td>-0.033288</td>
<td>-0.000455</td>
<td> 0.000283</td>
<td>-0.038092</td>
<td> 0.776906</td>
<td> 0.812280</td>
<td>-0.650336</td>
<td>-0.646256</td>
<td>-0.278465</td>
<td>-0.282239</td>
<td> 0.732841</td>
<td>-0.727031</td>
<td>-0.222707</td>
<td> 0.189876</td>
<td> 0.769481</td>
<td> 0.771158</td>
<td>-0.766402</td>
<td> 1.000000</td>
<td>-0.175310</td>
<td>-0.658737</td>
<td>-0.652636</td>
<td>-0.299273</td>
<td>-0.297100</td>
</tr>
<tr>
<th>dst_host_srv_diff_host_rate</th>
<td> 0.100692</td>
<td>-0.140231</td>
<td> 0.578557</td>
<td> 0.016171</td>
<td> 0.007306</td>
<td>-0.000976</td>
<td>-0.014141</td>
<td>-0.002588</td>
<td> 0.659078</td>
<td>-0.020979</td>
<td> 0.008631</td>
<td> 0.001052</td>
<td> 0.061030</td>
<td> 0.030590</td>
<td> 0.015882</td>
<td> 0.011765</td>
<td> 0.000288</td>
<td> 0.000538</td>
<td>-0.012578</td>
<td>-0.496554</td>
<td>-0.391712</td>
<td>-0.153568</td>
<td>-0.148072</td>
<td> 0.073061</td>
<td> 0.075178</td>
<td> 0.179040</td>
<td>-0.176930</td>
<td> 0.433173</td>
<td>-0.918894</td>
<td> 0.043668</td>
<td> 0.107926</td>
<td>-0.088665</td>
<td>-0.175310</td>
<td> 1.000000</td>
<td>-0.118697</td>
<td>-0.103715</td>
<td> 0.114971</td>
<td> 0.120767</td>
</tr>
<tr>
<th>dst_host_serror_rate</th>
<td>-0.056753</td>
<td>-0.645920</td>
<td>-0.167047</td>
<td> 0.013566</td>
<td> 0.010387</td>
<td>-0.001381</td>
<td>-0.004706</td>
<td> 0.014713</td>
<td>-0.143283</td>
<td>-0.005019</td>
<td>-0.003498</td>
<td> 0.001974</td>
<td>-0.008457</td>
<td>-0.002257</td>
<td>-0.001588</td>
<td>-0.011197</td>
<td>-0.000011</td>
<td>-0.000076</td>
<td>-0.001066</td>
<td>-0.331571</td>
<td>-0.449096</td>
<td> 0.973947</td>
<td> 0.967214</td>
<td>-0.094076</td>
<td>-0.096146</td>
<td>-0.830067</td>
<td> 0.807205</td>
<td>-0.097973</td>
<td> 0.123881</td>
<td>-0.722607</td>
<td>-0.742045</td>
<td> 0.719275</td>
<td>-0.658737</td>
<td>-0.118697</td>
<td> 1.000000</td>
<td> 0.968015</td>
<td>-0.087531</td>
<td>-0.096899</td>
</tr>
<tr>
<th>dst_host_srv_serror_rate</th>
<td>-0.057298</td>
<td>-0.641792</td>
<td>-0.158378</td>
<td> 0.012265</td>
<td>-0.024117</td>
<td>-0.001370</td>
<td>-0.010721</td>
<td> 0.014914</td>
<td>-0.132474</td>
<td>-0.004504</td>
<td>-0.003032</td>
<td> 0.002893</td>
<td>-0.007096</td>
<td>-0.004295</td>
<td>-0.002357</td>
<td>-0.011487</td>
<td>-0.000372</td>
<td>-0.000007</td>
<td>-0.016885</td>
<td>-0.335290</td>
<td>-0.442823</td>
<td> 0.965663</td>
<td> 0.970617</td>
<td>-0.110646</td>
<td>-0.114341</td>
<td>-0.819335</td>
<td> 0.795844</td>
<td>-0.092661</td>
<td> 0.113845</td>
<td>-0.708392</td>
<td>-0.725272</td>
<td> 0.701149</td>
<td>-0.652636</td>
<td>-0.103715</td>
<td> 0.968015</td>
<td> 1.000000</td>
<td>-0.111578</td>
<td>-0.110532</td>
</tr>
<tr>
<th>dst_host_rerror_rate</th>
<td>-0.007759</td>
<td>-0.297338</td>
<td>-0.003042</td>
<td> 0.000389</td>
<td> 0.046656</td>
<td>-0.000786</td>
<td> 0.199019</td>
<td> 0.032395</td>
<td> 0.007236</td>
<td> 0.214115</td>
<td> 0.002763</td>
<td> 0.003173</td>
<td>-0.000421</td>
<td> 0.000626</td>
<td>-0.000617</td>
<td>-0.004743</td>
<td>-0.000823</td>
<td>-0.000435</td>
<td> 0.025282</td>
<td>-0.261194</td>
<td>-0.313442</td>
<td>-0.103198</td>
<td>-0.122630</td>
<td> 0.910225</td>
<td> 0.904591</td>
<td>-0.282487</td>
<td> 0.299041</td>
<td> 0.022585</td>
<td>-0.125142</td>
<td>-0.312040</td>
<td>-0.278068</td>
<td> 0.287476</td>
<td>-0.299273</td>
<td> 0.114971</td>
<td>-0.087531</td>
<td>-0.111578</td>
<td> 1.000000</td>
<td> 0.950964</td>
</tr>
<tr>
<th>dst_host_srv_rerror_rate</th>
<td>-0.013891</td>
<td>-0.300581</td>
<td> 0.001621</td>
<td>-0.001816</td>
<td>-0.013666</td>
<td>-0.000782</td>
<td> 0.189142</td>
<td> 0.032151</td>
<td> 0.012979</td>
<td> 0.217858</td>
<td> 0.002151</td>
<td> 0.001731</td>
<td>-0.005012</td>
<td>-0.001096</td>
<td>-0.002020</td>
<td>-0.004552</td>
<td>-0.001038</td>
<td>-0.000529</td>
<td>-0.004292</td>
<td>-0.256176</td>
<td>-0.308132</td>
<td>-0.105434</td>
<td>-0.124656</td>
<td> 0.911622</td>
<td> 0.914904</td>
<td>-0.282913</td>
<td> 0.298904</td>
<td> 0.024722</td>
<td>-0.125273</td>
<td>-0.300787</td>
<td>-0.264383</td>
<td> 0.271067</td>
<td>-0.297100</td>
<td> 0.120767</td>
<td>-0.096899</td>
<td>-0.110532</td>
<td> 0.950964</td>
<td> 1.000000</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We have used a <em>Pandas</em> <code>DataFrame</code> here to render the correlation matrix in a more comprehensive way. Now we want those variables that are highly correlated. For that we do a bit of dataframe manipulation.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [22]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># get a boolean dataframe where true means that a pair of variables is highly correlated</span>
<span class="n">highly_correlated_df</span> <span class="o">=</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">corr_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">corr_df</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="c1"># get the names of the variables so we can use them to slice the dataframe</span>
<span class="n">correlated_vars_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">highly_correlated_df</span><span class="o">==</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
<span class="n">correlated_var_names</span> <span class="o">=</span> <span class="n">correlated_vars_index</span><span class="p">[</span><span class="n">correlated_vars_index</span><span class="o">==</span><span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
<span class="c1"># slice it</span>
<span class="n">highly_correlated_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">correlated_var_names</span><span class="p">,</span><span class="n">correlated_var_names</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[22]:</div>
<div class="output_html rendered_html output_subarea output_execute_result">
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>src_bytes</th>
<th>dst_bytes</th>
<th>hot</th>
<th>logged_in</th>
<th>num_compromised</th>
<th>num_outbound_cmds</th>
<th>is_hot_login</th>
<th>count</th>
<th>srv_count</th>
<th>serror_rate</th>
<th>srv_serror_rate</th>
<th>rerror_rate</th>
<th>srv_rerror_rate</th>
<th>same_srv_rate</th>
<th>diff_srv_rate</th>
<th>dst_host_count</th>
<th>dst_host_srv_count</th>
<th>dst_host_same_srv_rate</th>
<th>dst_host_diff_srv_rate</th>
<th>dst_host_same_src_port_rate</th>
<th>dst_host_srv_diff_host_rate</th>
<th>dst_host_serror_rate</th>
<th>dst_host_srv_serror_rate</th>
<th>dst_host_rerror_rate</th>
<th>dst_host_srv_rerror_rate</th>
</tr>
</thead>
<tbody>
<tr>
<th>src_bytes</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>dst_bytes</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>hot</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>logged_in</th>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>num_compromised</th>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>num_outbound_cmds</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>is_hot_login</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>count</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>srv_count</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>serror_rate</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>srv_serror_rate</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>rerror_rate</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
</tr>
<tr>
<th>srv_rerror_rate</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
</tr>
<tr>
<th>same_srv_rate</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>diff_srv_rate</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>dst_host_count</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>dst_host_srv_count</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>dst_host_same_srv_rate</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>dst_host_diff_srv_rate</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>dst_host_same_src_port_rate</th>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>dst_host_srv_diff_host_rate</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>dst_host_serror_rate</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>dst_host_srv_serror_rate</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
</tr>
<tr>
<th>dst_host_rerror_rate</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
</tr>
<tr>
<th>dst_host_srv_rerror_rate</th>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td>  True</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td> False</td>
<td>  True</td>
<td> False</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Conclusions-and-possible-model-selection-hints">Conclusions and possible model selection hints<a class="anchor-link" href="#Conclusions-and-possible-model-selection-hints">¶</a></h3><p>The previous dataframe showed us which variables are highly correlated. We have kept just those variables with at least one strong correlation. We can use as we please, but a good way could be to do some model selection. That is, if we have a group of variables that are highly correlated, we can keep just one of them to represent the group under the assumption that they convey similar information as predictors. Reducing the number of variables will not improve our model accuracy, but it will make it easier to understand and also more efficient to compute.</p>
<p>For example, from the description of the <a href="http://kdd.ics.uci.edu/databases/kddcup99/task.html">KDD Cup 99 task</a> we know that the variable <code>dst_host_same_src_port_rate</code> references the percentage of the last 100 connections to the same port, for the same destination host. In our correlation matrix (and auxiliar dataframes) we find that this one is highly and positively correlated to <code>src_bytes</code> and <code>srv_count</code>. The former is the number of bytes sent form source to destination. The later is the number of connections to the same service as the current connection in the past 2 seconds. We might decide not to include <code>dst_host_same_src_port_rate</code> in our model if we include the other two, as a way to reduce the number of variables and later one better interpret our models.</p>
<p>Later on, in those notebooks dedicated to build predictive models, we will make use of this information to build more interpretable models.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="MLlib:-Classification-with-Logistic-Regression">MLlib: Classification with Logistic Regression<a class="anchor-link" href="#MLlib:-Classification-with-Logistic-Regression">¶</a></h1><p>In this notebook we will use Spark's machine learning library <a href="https://spark.apache.org/docs/latest/mllib-guide.html">MLlib</a> to build a <strong>Logistic Regression</strong> classifier for network attack detection. We will use the complete <a href="http://kdd.ics.uci.edu/databases/kddcup99/kddcup99.html">KDD Cup 1999</a> datasets in order to test Spark capabilities with large datasets.</p>
<p>Additionally, we will introduce two ways of performing <strong>model selection</strong>: by using a correlation matrix and by using hypothesis testing.</p>
<p>At the time of processing this notebook, our Spark cluster contains:</p>
<ul>
<li>Eight nodes, with one of them acting as master and the rest as workers.  </li>
<li>Each node contains 8Gb of RAM, with 6Gb being used for each node.  </li>
<li>Each node has a 2.4Ghz Intel dual core processor.  </li>
</ul>
<h2 id="Getting-the-data-and-creating-the-RDD">Getting the data and creating the RDD<a class="anchor-link" href="#Getting-the-data-and-creating-the-RDD">¶</a></h2><p>As we said, this time we will use the complete dataset provided for the <a href="http://kdd.ics.uci.edu/databases/kddcup99/kddcup99.html">KDD Cup 1999</a>, containing nearly half million network interactions. The file is provided as a Gzip file that we will download locally.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [1]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">urllib</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span> <span class="p">(</span><span class="s2">"http://kdd.ics.uci.edu/databases/kddcup99/kddcup.data.gz"</span><span class="p">,</span> <span class="s2">"kddcup.data.gz"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [2]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data_file</span> <span class="o">=</span> <span class="s2">"./kddcup.data.gz"</span>
<span class="n">raw_data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>

<span class="nb">print</span> <span class="s2">"Train data size is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">raw_data</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Train data size is 4898431
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <a href="http://kdd.ics.uci.edu/databases/kddcup99/kddcup99.html">KDD Cup 1999</a> also provide test data that we will load in a separate RDD.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">ft</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="s2">"http://kdd.ics.uci.edu/databases/kddcup99/corrected.gz"</span><span class="p">,</span> <span class="s2">"corrected.gz"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">test_data_file</span> <span class="o">=</span> <span class="s2">"./corrected.gz"</span>
<span class="n">test_raw_data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="n">test_data_file</span><span class="p">)</span>

<span class="nb">print</span> <span class="s2">"Test data size is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_raw_data</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Test data size is 311029
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Labeled-Points">Labeled Points<a class="anchor-link" href="#Labeled-Points">¶</a></h2><p>A labeled point is a local vector associated with a label/response. In <a href="https://spark.apache.org/docs/latest/mllib-data-types.html#labeled-point">MLlib</a>, labeled points are used in supervised learning algorithms and they are stored as doubles. For binary classification, a label should be either 0 (negative) or 1 (positive).</p>
<h3 id="Preparing-the-training-data">Preparing the training data<a class="anchor-link" href="#Preparing-the-training-data">¶</a></h3><p>In our case, we are interested in detecting network attacks in general. We don't need to detect which type of attack we are dealing with. Therefore we will tag each network interaction as non attack (i.e. 'normal' tag) or attack (i.e. anything else but 'normal').</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [5]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.mllib.regression</span> <span class="k">import</span> <span class="n">LabeledPoint</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">array</span>

<span class="k">def</span> <span class="nf">parse_interaction</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">line_split</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">)</span>
    <span class="c1"># leave_out = [1,2,3,41]</span>
    <span class="n">clean_line_split</span> <span class="o">=</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">line_split</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">41</span><span class="p">]</span>
    <span class="n">attack</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span><span class="o">==</span><span class="s1">'normal.'</span><span class="p">:</span>
        <span class="n">attack</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">LabeledPoint</span><span class="p">(</span><span class="n">attack</span><span class="p">,</span> <span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">clean_line_split</span><span class="p">]))</span>

<span class="n">training_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parse_interaction</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Preparing-the-test-data">Preparing the test data<a class="anchor-link" href="#Preparing-the-test-data">¶</a></h3><p>Similarly, we process our test data file.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [6]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">test_data</span> <span class="o">=</span> <span class="n">test_raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parse_interaction</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Detecting-network-attacks-using-Logistic-Regression">Detecting network attacks using Logistic Regression<a class="anchor-link" href="#Detecting-network-attacks-using-Logistic-Regression">¶</a></h2><p><a href="http://en.wikipedia.org/wiki/Logistic_regression">Logistic regression</a> is widely used to predict a binary response. Spark implements <a href="https://spark.apache.org/docs/latest/mllib-linear-methods.html#logistic-regression">two algorithms</a> to solve logistic regression: mini-batch gradient descent and L-BFGS. L-BFGS is recommended over mini-batch gradient descent for faster convergence.</p>
<h3 id="Training-a-classifier">Training a classifier<a class="anchor-link" href="#Training-a-classifier">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [7]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.mllib.classification</span> <span class="k">import</span> <span class="n">LogisticRegressionWithLBFGS</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>

<span class="c1"># Build the model</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">logit_model</span> <span class="o">=</span> <span class="n">LogisticRegressionWithLBFGS</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">training_data</span><span class="p">)</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="nb">print</span> <span class="s2">"Classifier trained in </span><span class="si">{}</span><span class="s2"> seconds"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Classifier trained in 365.599 seconds
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Evaluating-the-model-on-new-data">Evaluating the model on new data<a class="anchor-link" href="#Evaluating-the-model-on-new-data">¶</a></h3><p>In order to measure the classification error on our test data, we use <code>map</code> on the <code>test_data</code> RDD and the model to predict each test point class.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [8]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">labels_and_preds</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">logit_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">features</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Classification results are returned in pars, with the actual test label and the predicted one. This is used to calculate the classification error by using <code>filter</code> and <code>count</code> as follows.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [9]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">test_accuracy</span> <span class="o">=</span> <span class="n">labels_and_preds</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span> <span class="n">v</span> <span class="o">==</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="nb">print</span> <span class="s2">"Prediction made in </span><span class="si">{}</span><span class="s2"> seconds. Test accuracy is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">test_accuracy</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Prediction made in 34.291 seconds. Test accuracy is 0.9164
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>That's a decent accuracy. We know that there is space for improvement with a better variable selection and also by including categorical variables (e.g. we have excluded 'protocol' and 'service').</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Model-selection">Model selection<a class="anchor-link" href="#Model-selection">¶</a></h2><p>Model or feature selection helps us building more interpretable and efficient models (or a classifier in this case). For illustrative purposes, we will follow two different approaches, correlation matrices and hypothesis testing.</p>
<h3 id="Using-a-correlation-matrix">Using a correlation matrix<a class="anchor-link" href="#Using-a-correlation-matrix">¶</a></h3><p>In a <a href="https://github.com/jadianes/spark-py-notebooks/blob/master/nb7-mllib-statistics/nb7-mllib-statistics.ipynb">previous notebook</a> we calculated a correlation matrix in order to find predictors that are highly correlated. There are many possible choices there in order to simplify our model. We can pick different combinations of correlated variables and leave just those that represent them. The reader can try different combinations. Here we will choose the following for illustrative purposes:</p>
<ul>
<li><p>From the description of the <a href="http://kdd.ics.uci.edu/databases/kddcup99/task.html">KDD Cup 99 task</a> we know that the variable <code>dst_host_same_src_port_rate</code> references the percentage of the last 100 connections to the same port, for the same destination host. In our correlation matrix (and auxiliary dataframes) we find that this one is highly and positively correlated to <code>src_bytes</code> and <code>srv_count</code>. The former is the number of bytes sent form source to destination. The later is the number of connections to the same service as the current connection in the past 2 seconds. We decide not to include <code>dst_host_same_src_port_rate</code> in our model since we include the other two.</p>
</li>
<li><p>Variables <code>serror_rate</code> and <code>srv_error_rate</code> (% of connections that have <em>SYN</em> errors for same host and same service respectively) are highly positively correlated. Moreover, the set of variables that they highly correlate with are pretty much the same. They look like contributing very similarly to our model. We will keep just <code>serror_rate</code>.</p>
</li>
<li><p>A similar situation happens with <code>rerror_rate</code> and <code>srv_rerror_rate</code> (% of connections that have <em>REJ</em> errors) so we will keep just <code>rerror_rate</code>.</p>
</li>
<li><p>Same thing with variables prefixed with <code>dst_host_</code> for the previous ones (e.g. <code>dst_host_srv_serror_rate</code>).</p>
</li>
</ul>
<p>We will stop here, although the reader can keep experimenting removing correlated variables has before (e.g. <code>same_srv_rate</code> and <code>diff_srv_rate</code> are good candidates. Our list of variables we will drop includes:</p>
<ul>
<li><code>dst_host_same_src_port_rate</code>, (column 35).  </li>
<li><code>srv_serror_rate</code> (column 25).  </li>
<li><code>srv_rerror_rate</code> (column 27).  </li>
<li><code>dst_host_srv_serror_rate</code> (column 38).  </li>
<li><code>dst_host_srv_rerror_rate</code> (column 40).  </li>
</ul>
<h4 id="Evaluating-the-new-model">Evaluating the new model<a class="anchor-link" href="#Evaluating-the-new-model">¶</a></h4><p>Let's proceed with the evaluation of our reduced model. First we need to provide training and testing datasets containing just the selected variables. For that we will define a new function to parse the raw data that keeps just what we need.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [10]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">parse_interaction_corr</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">line_split</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">)</span>
    <span class="c1"># leave_out = [1,2,3,25,27,35,38,40,41]</span>
    <span class="n">clean_line_split</span> <span class="o">=</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">line_split</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">25</span><span class="p">]</span><span class="o">+</span><span class="n">line_split</span><span class="p">[</span><span class="mi">26</span><span class="p">:</span><span class="mi">27</span><span class="p">]</span><span class="o">+</span><span class="n">line_split</span><span class="p">[</span><span class="mi">28</span><span class="p">:</span><span class="mi">35</span><span class="p">]</span><span class="o">+</span><span class="n">line_split</span><span class="p">[</span><span class="mi">36</span><span class="p">:</span><span class="mi">38</span><span class="p">]</span><span class="o">+</span><span class="n">line_split</span><span class="p">[</span><span class="mi">39</span><span class="p">:</span><span class="mi">40</span><span class="p">]</span>
    <span class="n">attack</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span><span class="o">==</span><span class="s1">'normal.'</span><span class="p">:</span>
        <span class="n">attack</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">LabeledPoint</span><span class="p">(</span><span class="n">attack</span><span class="p">,</span> <span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">clean_line_split</span><span class="p">]))</span>

<span class="n">corr_reduced_training_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parse_interaction_corr</span><span class="p">)</span>
<span class="n">corr_reduced_test_data</span> <span class="o">=</span> <span class="n">test_raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parse_interaction_corr</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><em>Note: when selecting elements in the split, a list comprehension with a <code>leave_out</code> list for filtering is more Pythonic than slicing and concatenation indeed, but we have found it less efficient. This is very important when dealing with large datasets. The <code>parse_interaction</code> functions will be called for every element in the RDD, so we need to make them as efficient as possible.</em></p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we can train the model.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [11]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Build the model</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">logit_model_2</span> <span class="o">=</span> <span class="n">LogisticRegressionWithLBFGS</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">corr_reduced_training_data</span><span class="p">)</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="nb">print</span> <span class="s2">"Classifier trained in </span><span class="si">{}</span><span class="s2"> seconds"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Classifier trained in 319.124 seconds
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And evaluate its accuracy on the test data.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [12]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">labels_and_preds</span> <span class="o">=</span> <span class="n">corr_reduced_test_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">logit_model_2</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">features</span><span class="p">)))</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">test_accuracy</span> <span class="o">=</span> <span class="n">labels_and_preds</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span> <span class="n">v</span> <span class="o">==</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">corr_reduced_test_data</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="nb">print</span> <span class="s2">"Prediction made in </span><span class="si">{}</span><span class="s2"> seconds. Test accuracy is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">test_accuracy</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Prediction made in 34.102 seconds. Test accuracy is 0.8599
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As expected, we have reduced accuracy and also training time. However this doesn't seem a good trade! At least not for logistic regression and considering the predictors we decided to leave out. We have lost quite a lot of accuracy and have not gained a lot of execution time during training. Moreover prediction time didn't improve.</p>
<h3 id="Using-hypothesis-testing">Using hypothesis testing<a class="anchor-link" href="#Using-hypothesis-testing">¶</a></h3><p>Hypothesis testing is a powerful tool in statistical inference and learning to determine whether a result is statistically significant. MLlib supports Pearson's chi-squared (χ2) tests for goodness of fit and independence. The goodness of fit test requires an input type of <code>Vector</code>, whereas the independence test requires a <code>Matrix</code> as input. Moreover, MLlib also supports the input type <code>RDD[LabeledPoint]</code> to enable feature selection via chi-squared independence tests. Again, these methods are part of the <a href="https://spark.apache.org/docs/latest/api/python/pyspark.mllib.html#pyspark.mllib.stat.Statistics"><code>Statistics</code></a> package.</p>
<p>In our case we want to perform some sort of feature selection, so we will provide an RDD of <code>LabeledPoint</code>. Internally, MLlib will calculate a contingency matrix and perform the Persons's chi-squared (χ2) test. Features need to be categorical. Real-valued features will be treated as categorical in each of its different values. There is a limit of 1000 different values, so we need either to leave out some features or categorise them. In this case, we will consider just features that either take boolean values or just a few different numeric values in our dataset. We could overcome this limitation by defining a more complex <code>parse_interaction</code> function that categorises each feature properly.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [13]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"land"</span><span class="p">,</span><span class="s2">"wrong_fragment"</span><span class="p">,</span>
             <span class="s2">"urgent"</span><span class="p">,</span><span class="s2">"hot"</span><span class="p">,</span><span class="s2">"num_failed_logins"</span><span class="p">,</span><span class="s2">"logged_in"</span><span class="p">,</span><span class="s2">"num_compromised"</span><span class="p">,</span>
             <span class="s2">"root_shell"</span><span class="p">,</span><span class="s2">"su_attempted"</span><span class="p">,</span><span class="s2">"num_root"</span><span class="p">,</span><span class="s2">"num_file_creations"</span><span class="p">,</span>
             <span class="s2">"num_shells"</span><span class="p">,</span><span class="s2">"num_access_files"</span><span class="p">,</span><span class="s2">"num_outbound_cmds"</span><span class="p">,</span>
             <span class="s2">"is_hot_login"</span><span class="p">,</span><span class="s2">"is_guest_login"</span><span class="p">,</span><span class="s2">"count"</span><span class="p">,</span><span class="s2">"srv_count"</span><span class="p">,</span><span class="s2">"serror_rate"</span><span class="p">,</span>
             <span class="s2">"srv_serror_rate"</span><span class="p">,</span><span class="s2">"rerror_rate"</span><span class="p">,</span><span class="s2">"srv_rerror_rate"</span><span class="p">,</span><span class="s2">"same_srv_rate"</span><span class="p">,</span>
             <span class="s2">"diff_srv_rate"</span><span class="p">,</span><span class="s2">"srv_diff_host_rate"</span><span class="p">,</span><span class="s2">"dst_host_count"</span><span class="p">,</span><span class="s2">"dst_host_srv_count"</span><span class="p">,</span>
             <span class="s2">"dst_host_same_srv_rate"</span><span class="p">,</span><span class="s2">"dst_host_diff_srv_rate"</span><span class="p">,</span><span class="s2">"dst_host_same_src_port_rate"</span><span class="p">,</span>
             <span class="s2">"dst_host_srv_diff_host_rate"</span><span class="p">,</span><span class="s2">"dst_host_serror_rate"</span><span class="p">,</span><span class="s2">"dst_host_srv_serror_rate"</span><span class="p">,</span>
             <span class="s2">"dst_host_rerror_rate"</span><span class="p">,</span><span class="s2">"dst_host_srv_rerror_rate"</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [14]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">parse_interaction_categorical</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">line_split</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">)</span>
    <span class="n">clean_line_split</span> <span class="o">=</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">41</span><span class="p">]</span>
    <span class="n">attack</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span><span class="o">==</span><span class="s1">'normal.'</span><span class="p">:</span>
        <span class="n">attack</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">LabeledPoint</span><span class="p">(</span><span class="n">attack</span><span class="p">,</span> <span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">clean_line_split</span><span class="p">]))</span>

<span class="n">training_data_categorical</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parse_interaction_categorical</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [15]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.mllib.stat</span> <span class="k">import</span> <span class="n">Statistics</span>

<span class="n">chi</span> <span class="o">=</span> <span class="n">Statistics</span><span class="o">.</span><span class="n">chiSqTest</span><span class="p">(</span><span class="n">training_data_categorical</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we can check the resulting values after putting them into a <em>Pandas</em> data frame.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [16]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">'display.max_colwidth'</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

<span class="n">records</span> <span class="o">=</span> <span class="p">[(</span><span class="n">result</span><span class="o">.</span><span class="n">statistic</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">pValue</span><span class="p">)</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">chi</span><span class="p">]</span>

<span class="n">chi_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">records</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span> <span class="n">feature_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"Statistic"</span><span class="p">,</span><span class="s2">"p-value"</span><span class="p">])</span>

<span class="n">chi_df</span> 
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt output_prompt">Out[16]:</div>
<div class="output_html rendered_html output_subarea output_execute_result">
<div style="max-height:1000px;max-width:1500px;overflow:auto;">
<table class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>Statistic</th>
<th>p-value</th>
</tr>
</thead>
<tbody>
<tr>
<th>land</th>
<td>       0.464984</td>
<td> 0.495304</td>
</tr>
<tr>
<th>wrong_fragment</th>
<td>     306.855508</td>
<td> 0.000000</td>
</tr>
<tr>
<th>urgent</th>
<td>      38.718442</td>
<td> 0.000000</td>
</tr>
<tr>
<th>hot</th>
<td>   19463.314328</td>
<td> 0.000000</td>
</tr>
<tr>
<th>num_failed_logins</th>
<td>     127.769106</td>
<td> 0.000000</td>
</tr>
<tr>
<th>logged_in</th>
<td> 3273098.055702</td>
<td> 0.000000</td>
</tr>
<tr>
<th>num_compromised</th>
<td>    2011.862724</td>
<td> 0.000000</td>
</tr>
<tr>
<th>root_shell</th>
<td>    1044.917853</td>
<td> 0.000000</td>
</tr>
<tr>
<th>su_attempted</th>
<td>     433.999968</td>
<td> 0.000000</td>
</tr>
<tr>
<th>num_root</th>
<td>   22871.675646</td>
<td> 0.000000</td>
</tr>
<tr>
<th>num_file_creations</th>
<td>    9179.739210</td>
<td> 0.000000</td>
</tr>
<tr>
<th>num_shells</th>
<td>    1380.027801</td>
<td> 0.000000</td>
</tr>
<tr>
<th>num_access_files</th>
<td>   18734.770753</td>
<td> 0.000000</td>
</tr>
<tr>
<th>num_outbound_cmds</th>
<td>       0.000000</td>
<td> 1.000000</td>
</tr>
<tr>
<th>is_hot_login</th>
<td>       8.070987</td>
<td> 0.004498</td>
</tr>
<tr>
<th>is_guest_login</th>
<td>   13500.511066</td>
<td> 0.000000</td>
</tr>
<tr>
<th>count</th>
<td> 4546398.359513</td>
<td> 0.000000</td>
</tr>
<tr>
<th>srv_count</th>
<td> 2296059.697747</td>
<td> 0.000000</td>
</tr>
<tr>
<th>serror_rate</th>
<td>  268419.919232</td>
<td> 0.000000</td>
</tr>
<tr>
<th>srv_serror_rate</th>
<td>  302626.967659</td>
<td> 0.000000</td>
</tr>
<tr>
<th>rerror_rate</th>
<td>    9860.453313</td>
<td> 0.000000</td>
</tr>
<tr>
<th>srv_rerror_rate</th>
<td>   32476.385256</td>
<td> 0.000000</td>
</tr>
<tr>
<th>same_srv_rate</th>
<td>  399912.444046</td>
<td> 0.000000</td>
</tr>
<tr>
<th>diff_srv_rate</th>
<td>  390999.770051</td>
<td> 0.000000</td>
</tr>
<tr>
<th>srv_diff_host_rate</th>
<td> 1365458.716670</td>
<td> 0.000000</td>
</tr>
<tr>
<th>dst_host_count</th>
<td> 2520478.944345</td>
<td> 0.000000</td>
</tr>
<tr>
<th>dst_host_srv_count</th>
<td> 1439086.154193</td>
<td> 0.000000</td>
</tr>
<tr>
<th>dst_host_same_srv_rate</th>
<td> 1237931.905888</td>
<td> 0.000000</td>
</tr>
<tr>
<th>dst_host_diff_srv_rate</th>
<td> 1339002.406545</td>
<td> 0.000000</td>
</tr>
<tr>
<th>dst_host_same_src_port_rate</th>
<td> 2915195.296767</td>
<td> 0.000000</td>
</tr>
<tr>
<th>dst_host_srv_diff_host_rate</th>
<td> 2226290.874366</td>
<td> 0.000000</td>
</tr>
<tr>
<th>dst_host_serror_rate</th>
<td>  407454.601492</td>
<td> 0.000000</td>
</tr>
<tr>
<th>dst_host_srv_serror_rate</th>
<td>  455099.001618</td>
<td> 0.000000</td>
</tr>
<tr>
<th>dst_host_rerror_rate</th>
<td>  136478.956325</td>
<td> 0.000000</td>
</tr>
<tr>
<th>dst_host_srv_rerror_rate</th>
<td>  254547.369785</td>
<td> 0.000000</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>From that we conclude that predictors <code>land</code> and <code>num_outbound_cmds</code> could be removed from our model without affecting our accuracy dramatically. Let's try this.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Evaluating-the-new-model">Evaluating the new model<a class="anchor-link" href="#Evaluating-the-new-model">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So the only modification to our first <code>parse_interaction</code> function will be to remove columns 6 and 19, corresponding to the two predictors that we want not to be part of our model.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [17]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">parse_interaction_chi</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">line_split</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">)</span>
    <span class="c1"># leave_out = [1,2,3,6,19,41]</span>
    <span class="n">clean_line_split</span> <span class="o">=</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">7</span><span class="p">:</span><span class="mi">19</span><span class="p">]</span> <span class="o">+</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">41</span><span class="p">]</span>
    <span class="n">attack</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span><span class="o">==</span><span class="s1">'normal.'</span><span class="p">:</span>
        <span class="n">attack</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">LabeledPoint</span><span class="p">(</span><span class="n">attack</span><span class="p">,</span> <span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">clean_line_split</span><span class="p">]))</span>

<span class="n">training_data_chi</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parse_interaction_chi</span><span class="p">)</span>
<span class="n">test_data_chi</span> <span class="o">=</span> <span class="n">test_raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">parse_interaction_chi</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we build the logistic regression classifier again.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [18]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Build the model</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">logit_model_chi</span> <span class="o">=</span> <span class="n">LogisticRegressionWithLBFGS</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">training_data_chi</span><span class="p">)</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="nb">print</span> <span class="s2">"Classifier trained in </span><span class="si">{}</span><span class="s2"> seconds"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Classifier trained in 356.507 seconds
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And evaluate in test data.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [19]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">labels_and_preds</span> <span class="o">=</span> <span class="n">test_data_chi</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="n">logit_model_chi</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">features</span><span class="p">)))</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">test_accuracy</span> <span class="o">=</span> <span class="n">labels_and_preds</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span> <span class="n">v</span> <span class="o">==</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">test_data_chi</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="nb">print</span> <span class="s2">"Prediction made in </span><span class="si">{}</span><span class="s2"> seconds. Test accuracy is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">test_accuracy</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Prediction made in 34.656 seconds. Test accuracy is 0.9164
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So we can see that, by using hypothesis testing, we have been able to remove two predictors without diminishing testing accuracy at all. Training time improved a bit as well. This might now seem like a big model reduction, but it is something when dealing with big data sources. Moreover, we should be able to categorise those five predictors we have left out for different reasons and, either include them in the model or leave them out if they aren't statistically significant.</p>
<p>Additionally, we could try to remove some of those predictors that are highly correlated, trying not to reduce accuracy too much. In the end, we should end up with a model easier to understand and use.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="MLlib:-Decision-Trees">MLlib: Decision Trees<a class="anchor-link" href="#MLlib:-Decision-Trees">¶</a></h1><p>In this notebook we will use Spark's machine learning library <a href="https://spark.apache.org/docs/latest/mllib-guide.html">MLlib</a> to build a <strong>Decision Tree</strong> classifier for network attack detection. We will use the complete <a href="http://kdd.ics.uci.edu/databases/kddcup99/kddcup99.html">KDD Cup 1999</a> datasets in order to test Spark capabilities with large datasets.</p>
<p>Decision trees are a popular machine learning tool in part because they are easy to interpret, handle categorical features, extend to the multiclass classification setting, do not require feature scaling, and are able to capture non-linearities and feature interactions. In this notebook, we will first train a classification tree including every single predictor. Then we will use our results to perform model selection. Once we find out the most important ones (the main splits in the tree) we will build a minimal tree using just three of them (the first two levels of the tree in order to compare performance and accuracy.</p>
<p>At the time of processing this notebook, our Spark cluster contains:</p>
<ul>
<li>Eight nodes, with one of them acting as master and the rest as workers.  </li>
<li>Each node contains 8Gb of RAM, with 6Gb being used for each node.  </li>
<li>Each node has a 2.4Ghz Intel dual core processor.  </li>
<li>Running Apache Spark 1.3.1.  </li>
</ul>
<h2 id="Getting-the-data-and-creating-the-RDD">Getting the data and creating the RDD<a class="anchor-link" href="#Getting-the-data-and-creating-the-RDD">¶</a></h2><p>As we said, this time we will use the complete dataset provided for the <a href="http://kdd.ics.uci.edu/databases/kddcup99/kddcup99.html">KDD Cup 1999</a>, containing nearly half million network interactions. The file is provided as a Gzip file that we will download locally.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [1]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">urllib</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [2]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span> <span class="p">(</span><span class="s2">"http://kdd.ics.uci.edu/databases/kddcup99/kddcup.data.gz"</span><span class="p">,</span> <span class="s2">"kddcup.data.gz"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data_file</span> <span class="o">=</span> <span class="s2">"./kddcup.data.gz"</span>
<span class="n">raw_data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span>

<span class="nb">print</span> <span class="s2">"Train data size is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">raw_data</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Train data size is 4898431
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <a href="http://kdd.ics.uci.edu/databases/kddcup99/kddcup99.html">KDD Cup 1999</a> also provide test data that we will load in a separate RDD.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">ft</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span><span class="p">(</span><span class="s2">"http://kdd.ics.uci.edu/databases/kddcup99/corrected.gz"</span><span class="p">,</span> <span class="s2">"corrected.gz"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [5]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">test_data_file</span> <span class="o">=</span> <span class="s2">"./corrected.gz"</span>
<span class="n">test_raw_data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="n">test_data_file</span><span class="p">)</span>

<span class="nb">print</span> <span class="s2">"Test data size is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">test_raw_data</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Test data size is 311029
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Detecting-network-attacks-using-Decision-Trees">Detecting network attacks using Decision Trees<a class="anchor-link" href="#Detecting-network-attacks-using-Decision-Trees">¶</a></h2><p>In this section we will train a <em>classification tree</em> that, as we did with <em>logistic regression</em>, will predict if a network interaction is either <code>normal</code> or <code>attack</code>.</p>
<p>Training a classification tree using <a href="https://spark.apache.org/docs/latest/mllib-decision-tree.html">MLlib</a> requires some parameters:</p>
<ul>
<li>Training data  </li>
<li>Num classes  </li>
<li>Categorical features info: a map from column to categorical variables arity. This is optional, although it should increase model accuracy. However it requires that we know the levels in our categorical variables in advance. second we need to parse our data to convert labels to integer values within the arity range.  </li>
<li>Impurity metric  </li>
<li>Tree maximum depth  </li>
<li>And tree maximum number of bins  </li>
</ul>
<p>In the next section we will see how to obtain all the labels within a dataset and convert them to numerical factors.</p>
<h3 id="Preparing-the-data">Preparing the data<a class="anchor-link" href="#Preparing-the-data">¶</a></h3><p>As we said, in order to benefits from trees ability to seamlessly with categorical variables, we need to convert them to numerical factors. But first we need to obtain all the possible levels. We will use <em>set</em> transformations on a csv parsed RDD.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [6]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.mllib.regression</span> <span class="k">import</span> <span class="n">LabeledPoint</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">array</span>

<span class="n">csv_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">))</span>
<span class="n">test_csv_data</span> <span class="o">=</span> <span class="n">test_raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">))</span>

<span class="n">protocols</span> <span class="o">=</span> <span class="n">csv_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="n">services</span> <span class="o">=</span> <span class="n">csv_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
<span class="n">flags</span> <span class="o">=</span> <span class="n">csv_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And now we can use this Python lists in our <code>create_labeled_point</code> function. If a factor level is not in the training data, we assign an especial level. Remember that we cannot use testing data for training our model, not even the factor levels. The testing data represents the unknown to us in a real case.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [7]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">create_labeled_point</span><span class="p">(</span><span class="n">line_split</span><span class="p">):</span>
    <span class="c1"># leave_out = [41]</span>
    <span class="n">clean_line_split</span> <span class="o">=</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">41</span><span class="p">]</span>
    
    <span class="c1"># convert protocol to numeric categorical variable</span>
    <span class="k">try</span><span class="p">:</span> 
        <span class="n">clean_line_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">protocols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">clean_line_split</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">clean_line_split</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">protocols</span><span class="p">)</span>
        
    <span class="c1"># convert service to numeric categorical variable</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">clean_line_split</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">clean_line_split</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">clean_line_split</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">services</span><span class="p">)</span>
    
    <span class="c1"># convert flag to numeric categorical variable</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">clean_line_split</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">flags</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">clean_line_split</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">clean_line_split</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
    
    <span class="c1"># convert label to binary label</span>
    <span class="n">attack</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span><span class="o">==</span><span class="s1">'normal.'</span><span class="p">:</span>
        <span class="n">attack</span> <span class="o">=</span> <span class="mf">0.0</span>
        
    <span class="k">return</span> <span class="n">LabeledPoint</span><span class="p">(</span><span class="n">attack</span><span class="p">,</span> <span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">clean_line_split</span><span class="p">]))</span>

<span class="n">training_data</span> <span class="o">=</span> <span class="n">csv_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">create_labeled_point</span><span class="p">)</span>
<span class="n">test_data</span> <span class="o">=</span> <span class="n">test_csv_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">create_labeled_point</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Training-a-classifier">Training a classifier<a class="anchor-link" href="#Training-a-classifier">¶</a></h3><p>We are now ready to train our classification tree. We will keep the <code>maxDepth</code> value small. This will lead to smaller accuracy, but we will obtain less splits so later on we can better interpret the tree. In a production system we will try to increase this value in order to find a better accuracy.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [8]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.mllib.tree</span> <span class="k">import</span> <span class="n">DecisionTree</span><span class="p">,</span> <span class="n">DecisionTreeModel</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>

<span class="c1"># Build the model</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">tree_model</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="o">.</span><span class="n">trainClassifier</span><span class="p">(</span><span class="n">training_data</span><span class="p">,</span> <span class="n">numClasses</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                                          <span class="n">categoricalFeaturesInfo</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">protocols</span><span class="p">),</span> <span class="mi">2</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">services</span><span class="p">),</span> <span class="mi">3</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">flags</span><span class="p">)},</span>
                                          <span class="n">impurity</span><span class="o">=</span><span class="s1">'gini'</span><span class="p">,</span> <span class="n">maxDepth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">maxBins</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="nb">print</span> <span class="s2">"Classifier trained in </span><span class="si">{}</span><span class="s2"> seconds"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Classifier trained in 439.971 seconds
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Evaluating-the-model">Evaluating the model<a class="anchor-link" href="#Evaluating-the-model">¶</a></h3><p>In order to measure the classification error on our test data, we use <code>map</code> on the <code>test_data</code> RDD and the model to predict each test point class.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [9]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">predictions</span> <span class="o">=</span> <span class="n">tree_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">features</span><span class="p">))</span>
<span class="n">labels_and_preds</span> <span class="o">=</span> <span class="n">test_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Classification results are returned in pars, with the actual test label and the predicted one. This is used to calculate the classification error by using <code>filter</code> and <code>count</code> as follows.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [10]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">test_accuracy</span> <span class="o">=</span> <span class="n">labels_and_preds</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span> <span class="n">v</span> <span class="o">==</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">test_data</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="nb">print</span> <span class="s2">"Prediction made in </span><span class="si">{}</span><span class="s2"> seconds. Test accuracy is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">test_accuracy</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Prediction made in 38.651 seconds. Test accuracy is 0.9155
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><em>NOTE: the zip transformation doesn't work properly with pySpark 1.2.1. It does in 1.3</em></p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Interpreting-the-model">Interpreting the model<a class="anchor-link" href="#Interpreting-the-model">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Understanding our tree splits is a great exercise in order to explain our classification labels in terms of predictors and the values they take. Using the <code>toDebugString</code> method in our three model we can obtain a lot of information regarding splits, nodes, etc.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [11]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="nb">print</span> <span class="s2">"Learned classification tree model:"</span>
<span class="nb">print</span> <span class="n">tree_model</span><span class="o">.</span><span class="n">toDebugString</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Learned classification tree model:
DecisionTreeModel classifier of depth 4 with 27 nodes
  If (feature 22 &lt;= 89.0)
   If (feature 3 in {2.0,3.0,4.0,7.0,9.0,10.0})
    If (feature 36 &lt;= 0.43)
     If (feature 28 &lt;= 0.19)
      Predict: 1.0
     Else (feature 28 &gt; 0.19)
      Predict: 0.0
    Else (feature 36 &gt; 0.43)
     If (feature 2 in {0.0,3.0,15.0,26.0,27.0,36.0,42.0,58.0,67.0})
      Predict: 0.0
     Else (feature 2 not in {0.0,3.0,15.0,26.0,27.0,36.0,42.0,58.0,67.0})
      Predict: 1.0
   Else (feature 3 not in {2.0,3.0,4.0,7.0,9.0,10.0})
    If (feature 2 in {50.0,51.0})
     Predict: 0.0
    Else (feature 2 not in {50.0,51.0})
     If (feature 32 &lt;= 168.0)
      Predict: 1.0
     Else (feature 32 &gt; 168.0)
      Predict: 0.0
  Else (feature 22 &gt; 89.0)
   If (feature 5 &lt;= 0.0)
    If (feature 11 &lt;= 0.0)
     If (feature 31 &lt;= 253.0)
      Predict: 1.0
     Else (feature 31 &gt; 253.0)
      Predict: 1.0
    Else (feature 11 &gt; 0.0)
     If (feature 2 in {12.0})
      Predict: 0.0
     Else (feature 2 not in {12.0})
      Predict: 1.0
   Else (feature 5 &gt; 0.0)
    If (feature 29 &lt;= 0.08)
     If (feature 2 in {3.0,4.0,26.0,36.0,42.0,58.0,68.0})
      Predict: 0.0
     Else (feature 2 not in {3.0,4.0,26.0,36.0,42.0,58.0,68.0})
      Predict: 1.0
    Else (feature 29 &gt; 0.08)
     Predict: 1.0

</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For example, a network interaction with the following features (see description <a href="http://kdd.ics.uci.edu/databases/kddcup99/task.html">here</a>) will be classified as an attack by our model:</p>
<ul>
<li><code>count</code>, the number of connections to the same host as the current connection in the past two seconds, being greater than 32. </li>
<li><code>dst_bytes</code>, the number of data bytes from destination to source, is 0.  </li>
<li><code>service</code> is neither level 0 nor 52.  </li>
<li><code>logged_in</code> is false.<br/>
From our services list we know that:  </li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [12]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="nb">print</span> <span class="s2">"Service 0 is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">services</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span> <span class="s2">"Service 52 is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">services</span><span class="p">[</span><span class="mi">52</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Service 0 is urp_i
Service 52 is tftp_u
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So we can characterise network interactions with more than 32 connections to the same server in the last 2 seconds, transferring zero bytes from destination to source, where service is neither <em>urp_i</em> nor <em>tftp_u</em>, and not logged in, as network attacks. A similar approach can be used for each tree terminal node.</p>
<p>We can see that <code>count</code> is the first node split in the tree. Remember that each partition is chosen greedily by selecting the best split from a set of possible splits, in order to maximize the information gain at a tree node (see more <a href="https://spark.apache.org/docs/latest/mllib-decision-tree.html#basic-algorithm">here</a>). At a second level we find variables <code>flag</code> (normal or error status of the connection) and <code>dst_bytes</code> (the number of data bytes from destination to source) and so on.</p>
<p>This explaining capability of a classification (or regression) tree is one of its main benefits. Understaining data is a key factor to build better models.</p>
<h2 id="Building-a-minimal-model-using-the-three-main-splits">Building a minimal model using the three main splits<a class="anchor-link" href="#Building-a-minimal-model-using-the-three-main-splits">¶</a></h2><p>So now that we know the main features predicting a network attack, thanks to our classification tree splits, let's use them to build a minimal classification tree with just the main three variables: <code>count</code>, <code>dst_bytes</code>, and <code>flag</code>.</p>
<p>We need to define the appropriate function to create labeled points.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [13]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">create_labeled_point_minimal</span><span class="p">(</span><span class="n">line_split</span><span class="p">):</span>
    <span class="c1"># leave_out = [41]</span>
    <span class="n">clean_line_split</span> <span class="o">=</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">+</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">23</span><span class="p">]</span>
    
    <span class="c1"># convert flag to numeric categorical variable</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">clean_line_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">flags</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">clean_line_split</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">clean_line_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span>
    
    <span class="c1"># convert label to binary label</span>
    <span class="n">attack</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span><span class="o">==</span><span class="s1">'normal.'</span><span class="p">:</span>
        <span class="n">attack</span> <span class="o">=</span> <span class="mf">0.0</span>
        
    <span class="k">return</span> <span class="n">LabeledPoint</span><span class="p">(</span><span class="n">attack</span><span class="p">,</span> <span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">clean_line_split</span><span class="p">]))</span>

<span class="n">training_data_minimal</span> <span class="o">=</span> <span class="n">csv_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">create_labeled_point_minimal</span><span class="p">)</span>
<span class="n">test_data_minimal</span> <span class="o">=</span> <span class="n">test_csv_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">create_labeled_point_minimal</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>That we use to train the model.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [14]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Build the model</span>
<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">tree_model_minimal</span> <span class="o">=</span> <span class="n">DecisionTree</span><span class="o">.</span><span class="n">trainClassifier</span><span class="p">(</span><span class="n">training_data_minimal</span><span class="p">,</span> <span class="n">numClasses</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
                                          <span class="n">categoricalFeaturesInfo</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">flags</span><span class="p">)},</span>
                                          <span class="n">impurity</span><span class="o">=</span><span class="s1">'gini'</span><span class="p">,</span> <span class="n">maxDepth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">maxBins</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="nb">print</span> <span class="s2">"Classifier trained in </span><span class="si">{}</span><span class="s2"> seconds"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Classifier trained in 226.519 seconds
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we can predict on the testing data and calculate accuracy.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [17]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">predictions_minimal</span> <span class="o">=</span> <span class="n">tree_model_minimal</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">test_data_minimal</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">features</span><span class="p">))</span>
<span class="n">labels_and_preds_minimal</span> <span class="o">=</span> <span class="n">test_data_minimal</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">label</span><span class="p">)</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span><span class="n">predictions_minimal</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [18]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">test_accuracy</span> <span class="o">=</span> <span class="n">labels_and_preds_minimal</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span> <span class="n">v</span> <span class="o">==</span> <span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">test_data_minimal</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="nb">print</span> <span class="s2">"Prediction made in </span><span class="si">{}</span><span class="s2"> seconds. Test accuracy is </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">test_accuracy</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Prediction made in 23.202 seconds. Test accuracy is 0.909
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So we have trained a classification tree with just the three most important predictors, in half of the time, and with a not so bad accuracy. In fact, a classification tree is a very good model selection tool!</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Spark-SQL-and-Data-Frames">Spark SQL and Data Frames<a class="anchor-link" href="#Spark-SQL-and-Data-Frames">¶</a></h1><p>This notebook will introduce Spark capabilities to deal with data in a structured way. Basically, everything turns around the concept of <em>Data Frame</em> and using <em>SQL language</em> to query them. We will see how the data frame abstraction, very popular in other data analytics ecosystems (e.g. R and Python/Pandas), it is very powerful when performing exploratory data analysis. In fact, it is very easy to express data queries when used together with the SQL language. Moreover, Spark distributes this column-based data structure transparently, in order to make the querying process as efficient as possible.</p>
<h2 id="Getting-the-data-and-creating-the-RDD">Getting the data and creating the RDD<a class="anchor-link" href="#Getting-the-data-and-creating-the-RDD">¶</a></h2><p>As we did in previous notebooks, we will use the reduced dataset (10 percent) provided for the <a href="http://kdd.ics.uci.edu/databases/kddcup99/kddcup99.html">KDD Cup 1999</a>, containing nearly half million nework interactions. The file is provided as a Gzip file that we will download locally.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [1]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">urllib</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlretrieve</span> <span class="p">(</span><span class="s2">"http://kdd.ics.uci.edu/databases/kddcup99/kddcup.data_10_percent.gz"</span><span class="p">,</span> <span class="s2">"kddcup.data_10_percent.gz"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [2]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">data_file</span> <span class="o">=</span> <span class="s2">"./kddcup.data_10_percent.gz"</span>
<span class="n">raw_data</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="n">data_file</span><span class="p">)</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Getting-a-Data-Frame">Getting a Data Frame<a class="anchor-link" href="#Getting-a-Data-Frame">¶</a></h2><p>A Spark <code>DataFrame</code> is a distributed collection of data organized into named columns. It is conceptually equivalent to a table in a relational database or a data frame in R or Pandas. They can be constructed from a wide array of sources such as a existing RDD in our case.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The entry point into all SQL functionality in Spark is the <code>SQLContext</code> class. To create a basic instance, all we need is a <code>SparkContext</code> reference. Since we are running Spark in shell mode (using pySpark) we can use the global context object <code>sc</code> for this purpose.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="k">import</span> <span class="n">SQLContext</span>
<span class="n">sqlContext</span> <span class="o">=</span> <span class="n">SQLContext</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Inferring-the-schema">Inferring the schema<a class="anchor-link" href="#Inferring-the-schema">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>With a <code>SQLContext</code>, we are ready to create a <code>DataFrame</code> from our existing RDD. But first we need to tell Spark SQL the schema in our data.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Spark SQL can convert an RDD of <code>Row</code> objects to a <code>DataFrame</code>. Rows are constructed by passing a list of key/value pairs as <em>kwargs</em> to the <code>Row</code> class. The keys define the column names, and the types are inferred by looking at the first row. Therefore, it is important that there is no missing data in the first row of the RDD in order to properly infer the schema.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In our case, we first need to split the comma separated data, and then use the information in KDD's 1999 task description to obtain the <a href="http://kdd.ics.uci.edu/databases/kddcup99/kddcup.names">column names</a>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="k">import</span> <span class="n">Row</span>

<span class="n">csv_data</span> <span class="o">=</span> <span class="n">raw_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">","</span><span class="p">))</span>
<span class="n">row_data</span> <span class="o">=</span> <span class="n">csv_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">Row</span><span class="p">(</span>
    <span class="n">duration</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
    <span class="n">protocol_type</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">service</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="n">flag</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
    <span class="n">src_bytes</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
    <span class="n">dst_bytes</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Once we have our RDD of <code>Row</code> we can infer and register the schema.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [5]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">interactions_df</span> <span class="o">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">row_data</span><span class="p">)</span>
<span class="n">interactions_df</span><span class="o">.</span><span class="n">registerTempTable</span><span class="p">(</span><span class="s2">"interactions"</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we can run SQL queries over our data frame that has been registered as a table.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [6]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Select tcp network interactions with more than 1 second duration and no transfer from destination</span>
<span class="n">tcp_interactions</span> <span class="o">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">"""</span>
<span class="s2">    SELECT duration, dst_bytes FROM interactions WHERE protocol_type = 'tcp' AND duration &gt; 1000 AND dst_bytes = 0</span>
<span class="s2">"""</span><span class="p">)</span>
<span class="n">tcp_interactions</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>duration dst_bytes
5057     0        
5059     0        
5051     0        
5056     0        
5051     0        
5039     0        
5062     0        
5041     0        
5056     0        
5064     0        
5043     0        
5061     0        
5049     0        
5061     0        
5048     0        
5047     0        
5044     0        
5063     0        
5068     0        
5062     0        
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The results of SQL queries are RDDs and support all the normal RDD operations.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [7]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Output duration together with dst_bytes</span>
<span class="n">tcp_interactions_out</span> <span class="o">=</span> <span class="n">tcp_interactions</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="s2">"Duration: </span><span class="si">{}</span><span class="s2">, Dest. bytes: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">dst_bytes</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ti_out</span> <span class="ow">in</span> <span class="n">tcp_interactions_out</span><span class="o">.</span><span class="n">collect</span><span class="p">():</span>
  <span class="nb">print</span> <span class="n">ti_out</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Duration: 5057, Dest. bytes: 0
Duration: 5059, Dest. bytes: 0
Duration: 5051, Dest. bytes: 0
Duration: 5056, Dest. bytes: 0
Duration: 5051, Dest. bytes: 0
Duration: 5039, Dest. bytes: 0
Duration: 5062, Dest. bytes: 0
Duration: 5041, Dest. bytes: 0
Duration: 5056, Dest. bytes: 0
Duration: 5064, Dest. bytes: 0
Duration: 5043, Dest. bytes: 0
Duration: 5061, Dest. bytes: 0
Duration: 5049, Dest. bytes: 0
Duration: 5061, Dest. bytes: 0
Duration: 5048, Dest. bytes: 0
Duration: 5047, Dest. bytes: 0
Duration: 5044, Dest. bytes: 0
Duration: 5063, Dest. bytes: 0
Duration: 5068, Dest. bytes: 0
Duration: 5062, Dest. bytes: 0
Duration: 5046, Dest. bytes: 0
Duration: 5052, Dest. bytes: 0
Duration: 5044, Dest. bytes: 0
Duration: 5054, Dest. bytes: 0
Duration: 5039, Dest. bytes: 0
Duration: 5058, Dest. bytes: 0
Duration: 5051, Dest. bytes: 0
Duration: 5032, Dest. bytes: 0
Duration: 5063, Dest. bytes: 0
Duration: 5040, Dest. bytes: 0
Duration: 5051, Dest. bytes: 0
Duration: 5066, Dest. bytes: 0
Duration: 5044, Dest. bytes: 0
Duration: 5051, Dest. bytes: 0
Duration: 5036, Dest. bytes: 0
Duration: 5055, Dest. bytes: 0
Duration: 2426, Dest. bytes: 0
Duration: 5047, Dest. bytes: 0
Duration: 5057, Dest. bytes: 0
Duration: 5037, Dest. bytes: 0
Duration: 5057, Dest. bytes: 0
Duration: 5062, Dest. bytes: 0
Duration: 5051, Dest. bytes: 0
Duration: 5051, Dest. bytes: 0
Duration: 5053, Dest. bytes: 0
Duration: 5064, Dest. bytes: 0
Duration: 5044, Dest. bytes: 0
Duration: 5051, Dest. bytes: 0
Duration: 5033, Dest. bytes: 0
Duration: 5066, Dest. bytes: 0
Duration: 5063, Dest. bytes: 0
Duration: 5056, Dest. bytes: 0
Duration: 5042, Dest. bytes: 0
Duration: 5063, Dest. bytes: 0
Duration: 5060, Dest. bytes: 0
Duration: 5056, Dest. bytes: 0
Duration: 5049, Dest. bytes: 0
Duration: 5043, Dest. bytes: 0
Duration: 5039, Dest. bytes: 0
Duration: 5041, Dest. bytes: 0
Duration: 42448, Dest. bytes: 0
Duration: 42088, Dest. bytes: 0
Duration: 41065, Dest. bytes: 0
Duration: 40929, Dest. bytes: 0
Duration: 40806, Dest. bytes: 0
Duration: 40682, Dest. bytes: 0
Duration: 40571, Dest. bytes: 0
Duration: 40448, Dest. bytes: 0
Duration: 40339, Dest. bytes: 0
Duration: 40232, Dest. bytes: 0
Duration: 40121, Dest. bytes: 0
Duration: 36783, Dest. bytes: 0
Duration: 36674, Dest. bytes: 0
Duration: 36570, Dest. bytes: 0
Duration: 36467, Dest. bytes: 0
Duration: 36323, Dest. bytes: 0
Duration: 36204, Dest. bytes: 0
Duration: 32038, Dest. bytes: 0
Duration: 31925, Dest. bytes: 0
Duration: 31809, Dest. bytes: 0
Duration: 31709, Dest. bytes: 0
Duration: 31601, Dest. bytes: 0
Duration: 31501, Dest. bytes: 0
Duration: 31401, Dest. bytes: 0
Duration: 31301, Dest. bytes: 0
Duration: 31194, Dest. bytes: 0
Duration: 31061, Dest. bytes: 0
Duration: 30935, Dest. bytes: 0
Duration: 30835, Dest. bytes: 0
Duration: 30735, Dest. bytes: 0
Duration: 30619, Dest. bytes: 0
Duration: 30518, Dest. bytes: 0
Duration: 30418, Dest. bytes: 0
Duration: 30317, Dest. bytes: 0
Duration: 30217, Dest. bytes: 0
Duration: 30077, Dest. bytes: 0
Duration: 25420, Dest. bytes: 0
Duration: 22921, Dest. bytes: 0
Duration: 22821, Dest. bytes: 0
Duration: 22721, Dest. bytes: 0
Duration: 22616, Dest. bytes: 0
Duration: 22516, Dest. bytes: 0
Duration: 22416, Dest. bytes: 0
Duration: 22316, Dest. bytes: 0
Duration: 22216, Dest. bytes: 0
Duration: 21987, Dest. bytes: 0
Duration: 21887, Dest. bytes: 0
Duration: 21767, Dest. bytes: 0
Duration: 21661, Dest. bytes: 0
Duration: 21561, Dest. bytes: 0
Duration: 21455, Dest. bytes: 0
Duration: 21334, Dest. bytes: 0
Duration: 21223, Dest. bytes: 0
Duration: 21123, Dest. bytes: 0
Duration: 20983, Dest. bytes: 0
Duration: 14682, Dest. bytes: 0
Duration: 14420, Dest. bytes: 0
Duration: 14319, Dest. bytes: 0
Duration: 14198, Dest. bytes: 0
Duration: 14098, Dest. bytes: 0
Duration: 13998, Dest. bytes: 0
Duration: 13898, Dest. bytes: 0
Duration: 13796, Dest. bytes: 0
Duration: 13678, Dest. bytes: 0
Duration: 13578, Dest. bytes: 0
Duration: 13448, Dest. bytes: 0
Duration: 13348, Dest. bytes: 0
Duration: 13241, Dest. bytes: 0
Duration: 13141, Dest. bytes: 0
Duration: 13033, Dest. bytes: 0
Duration: 12933, Dest. bytes: 0
Duration: 12833, Dest. bytes: 0
Duration: 12733, Dest. bytes: 0
Duration: 12001, Dest. bytes: 0
Duration: 5678, Dest. bytes: 0
Duration: 5010, Dest. bytes: 0
Duration: 1298, Dest. bytes: 0
Duration: 1031, Dest. bytes: 0
Duration: 36438, Dest. bytes: 0
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can easily have a look at our data frame schema using <code>printSchema</code>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [8]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">interactions_df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>root
 |-- dst_bytes: long (nullable = true)
 |-- duration: long (nullable = true)
 |-- flag: string (nullable = true)
 |-- protocol_type: string (nullable = true)
 |-- service: string (nullable = true)
 |-- src_bytes: long (nullable = true)

</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Queries-as-DataFrame-operations">Queries as <code>DataFrame</code> operations<a class="anchor-link" href="#Queries-as-DataFrame-operations">¶</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Spark <code>DataFrame</code> provides a domain-specific language for structured data manipulation. This language includes methods we can concatenate in order to do selection, filtering, grouping, etc. For example, let's say we want to count how many interactions are there for each protocol type. We can proceed as follows.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [9]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">interactions_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">"protocol_type"</span><span class="p">,</span> <span class="s2">"duration"</span><span class="p">,</span> <span class="s2">"dst_bytes"</span><span class="p">)</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">"protocol_type"</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="nb">print</span> <span class="s2">"Query performed in </span><span class="si">{}</span><span class="s2"> seconds"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>protocol_type count 
udp           20354 
tcp           190065
icmp          283602
Query performed in 20.568 seconds
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now imagine that we want to count how many interactions last more than 1 second, with no data transfer from destination, grouped by protocol type. We can just add to filter calls to the previous.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [10]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">interactions_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">"protocol_type"</span><span class="p">,</span> <span class="s2">"duration"</span><span class="p">,</span> <span class="s2">"dst_bytes"</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">interactions_df</span><span class="o">.</span><span class="n">duration</span><span class="o">&gt;</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">interactions_df</span><span class="o">.</span><span class="n">dst_bytes</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">"protocol_type"</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="nb">print</span> <span class="s2">"Query performed in </span><span class="si">{}</span><span class="s2"> seconds"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>protocol_type count
tcp           139  
Query performed in 16.641 seconds
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can use this to perform some <a href="http://en.wikipedia.org/wiki/Exploratory_data_analysis">exploratory data analysis</a>. Let's count how many attack and normal interactions we have. First we need to add the label column to our data.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [11]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_label_type</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">label</span><span class="o">!=</span><span class="s2">"normal."</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">"attack"</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">"normal"</span>
    
<span class="n">row_labeled_data</span> <span class="o">=</span> <span class="n">csv_data</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">Row</span><span class="p">(</span>
    <span class="n">duration</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> 
    <span class="n">protocol_type</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">service</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
    <span class="n">flag</span><span class="o">=</span><span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
    <span class="n">src_bytes</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span>
    <span class="n">dst_bytes</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]),</span>
    <span class="n">label</span><span class="o">=</span><span class="n">get_label_type</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">41</span><span class="p">])</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">interactions_labeled_df</span> <span class="o">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">row_labeled_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This time we don't need to register the schema since we are going to use the OO query interface.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's check the previous actually works by counting attack and normal data in our data frame.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [12]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">interactions_labeled_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">"label"</span><span class="p">)</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">"label"</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="nb">print</span> <span class="s2">"Query performed in </span><span class="si">{}</span><span class="s2"> seconds"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>label  count 
attack 396743
normal 97278 
Query performed in 17.325 seconds
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we want to count them by label and protocol type, in order to see how important the protocol type is to detect when an interaction is or not an attack.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [13]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">interactions_labeled_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">"label"</span><span class="p">,</span> <span class="s2">"protocol_type"</span><span class="p">)</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">"label"</span><span class="p">,</span> <span class="s2">"protocol_type"</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="nb">print</span> <span class="s2">"Query performed in </span><span class="si">{}</span><span class="s2"> seconds"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>label  protocol_type count 
attack udp           1177  
attack tcp           113252
attack icmp          282314
normal udp           19177 
normal tcp           76813 
normal icmp          1288  
Query performed in 17.253 seconds
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>At first sight it seems that <em>udp</em> interactions are in lower proportion between network attacks versus other protocol types.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And we can do much more sophisticated groupings. For example, add to the previous a "split" based on data transfer from target.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [14]:</div>
<div class="inner_cell">
<div class="input_area">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">interactions_labeled_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">"label"</span><span class="p">,</span> <span class="s2">"protocol_type"</span><span class="p">,</span> <span class="s2">"dst_bytes"</span><span class="p">)</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">"label"</span><span class="p">,</span> <span class="s2">"protocol_type"</span><span class="p">,</span> <span class="n">interactions_labeled_df</span><span class="o">.</span><span class="n">dst_bytes</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">tt</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

<span class="nb">print</span> <span class="s2">"Query performed in </span><span class="si">{}</span><span class="s2"> seconds"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>label  protocol_type (dst_bytes = 0) count 
normal icmp          true            1288  
attack udp           true            1166  
attack udp           false           11    
normal udp           true            3594  
normal udp           false           15583 
attack tcp           true            110583
attack tcp           false           2669  
normal tcp           true            9313  
normal tcp           false           67500 
attack icmp          true            282314
Query performed in 17.284 seconds
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We see how relevant is this new split to determine if a network interaction is an attack.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We will stop here, but we can see how powerful this type of queries are in order to explore our data. Actually we can replicate all the splits we saw in previous notebooks, when introducing classification trees, just by selecting, groping, and filtering our dataframe. For a more detailed (but less real-world) list of Spark's <code>DataFrame</code> operations and data sources, have a look at the official documentation <a href="https://spark.apache.org/docs/latest/sql-programming-guide.html#dataframe-operations">here</a>.</p>
</div>
</div>
</div>
</body>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = '//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: 'center'," +
        "    displayIndent: '0em'," +
        "    showMathMenu: true," +
        "    tex2jax: { " +
        "        inlineMath: [ ['$','$'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        " linebreaks: { automatic: true, width: '95% container' }, " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }" +
        "    } " +
        "}); ";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
</div>


            <footer>
<span class="byline author vcard">
    Posted by
    <span class="fn">
            niult
    </span>
</span><time datetime="2019-01-15T00:00:00+08:00" pubdate>2019-01-15 00:00</time><span class="categories">
        <a href="../../../category/tools.html">tools</a>
</span>

    <span class="categories">
            <a class="category" href="../../../tag/python.html">python</a>, 
            <a class="category" href="../../../tag/numpy.html">numpy</a>, 
            <a class="category" href="../../../tag/spark.html">spark</a>
    </span>

<div class="sharing">
</div>            </footer>
        </article>

    </div>
<aside class="sidebar">
    <section>
        <h1>Recent Posts</h1>
        <ul id="recent_posts">
                <li class="post">
                    <a href="../../../pages/2019/01/21-a-first-look-at-a-neural-network.html">2.1-a-first-look-at-a-neural-network</a>
                </li>
                <li class="post">
                    <a href="../../../pages/2019/01/35-classifying-movie-reviews.html">3.5-classifying-movie-reviews</a>
                </li>
                <li class="post">
                    <a href="../../../pages/2019/01/36-classifying-newswires.html">3.6-classifying-newswires</a>
                </li>
                <li class="post">
                    <a href="../../../pages/2019/01/37-predicting-house-prices.html">3.7-predicting-house-prices</a>
                </li>
                <li class="post">
                    <a href="../../../pages/2019/01/44-overfitting-and-underfitting.html">4.4-overfitting-and-underfitting</a>
                </li>
        </ul>
    </section>
        <section>

            <h1>Categories</h1>
            <ul id="recent_posts">
                    <li><a href="../../../category/01chang yong gong ju.html">01常用工具</a></li>
                    <li><a href="../../../category/02.wo ai du shu.html">02.我爱读书</a></li>
                    <li><a href="../../../category/algorithms.html">algorithms</a></li>
                    <li><a href="../../../category/book.html">book</a></li>
                    <li><a href="../../../category/book-pydata.html">book-pydata</a></li>
                    <li><a href="../../../category/deep-learning-with-python.html">deep-learning-with-python</a></li>
                    <li><a href="../../../category/ji qi xue xi shi zhan.html">机器学习实战</a></li>
                    <li><a href="../../../category/ke wai du wu.html">课外读物</a></li>
                    <li><a href="../../../category/ling ji chu ru men shen du xue xi.html">零基础入门深度学习</a></li>
                    <li><a href="../../../category/shen du xue xi.html">深度学习</a></li>
                    <li><a href="../../../category/shen jing wang luo.html">神经网络</a></li>
                    <li><a href="../../../category/shu ju wa jue.html">数据挖掘</a></li>
                    <li><a href="../../../category/shu xue ji chu.html">数学基础</a></li>
                    <li><a href="../../../category/tf-example.html">tf-example</a></li>
                    <li><a href="../../../category/tool1.html">tool1</a></li>
                    <li><a href="../../../category/tool2.html">tool2</a></li>
                    <li><a href="../../../category/tools.html">tools</a></li>
                    <li><a href="../../../category/tui jian xi tong.html">推荐系统</a></li>
                    <li><a href="../../../category/wen ben wa jue.html">文本挖掘</a></li>
            </ul>
        </section>


    <section>
        <h1>Tags</h1>
            <a href="../../../tag/python.html">python</a>, 
            <a href="../../../tag/numpy.html">numpy</a>, 
            <a href="../../../tag/deep-learning.html">deep-learning</a>, 
            <a href="../../../tag/algorithms.html">algorithms</a>, 
            <a href="../../../tag/wen-ben-wa-jue.html">文本挖掘</a>, 
            <a href="../../../tag/shen-jing-wang-luo.html">神经网络</a>, 
            <a href="../../../tag/shu-xue-ji-chu.html">数学基础</a>, 
            <a href="../../../tag/nlp.html">nlp</a>, 
            <a href="../../../tag/tf-example.html">tf-example</a>, 
            <a href="../../../tag/tui-jian-xi-tong.html">推荐系统</a>, 
            <a href="../../../tag/tf.html">tf</a>, 
            <a href="../../../tag/ji-huo-han-shu.html">激活函数</a>, 
            <a href="../../../tag/mapreduce.html">mapreduce</a>, 
            <a href="../../../tag/spark.html">spark</a>, 
            <a href="../../../tag/handbook.html">handbook</a>, 
            <a href="../../../tag/matplotlib.html">matplotlib</a>, 
            <a href="../../../tag/scikit-learn.html">scikit-learn</a>, 
            <a href="../../../tag/latex.html">latex</a>, 
            <a href="../../../tag/pandas.html">pandas</a>, 
            <a href="../../../tag/jupyter.html">jupyter</a>, 
            <a href="../../../tag/plot.html">plot</a>, 
            <a href="../../../tag/pip.html">pip</a>, 
            <a href="../../../tag/geng-xin-suo-you-mo-kuai.html">更新所有模块</a>, 
            <a href="../../../tag/shen-du-xue-xi.html">深度学习</a>, 
            <a href="../../../tag/xun-huan-shen-jing-wang-luo.html">循环神经网络</a>, 
            <a href="../../../tag/pangrank.html">PangRank</a>, 
            <a href="../../../tag/book.html">book</a>, 
            <a href="../../../tag/pydata.html">pydata</a>, 
            <a href="../../../tag/shell.html">shell</a>, 
            <a href="../../../tag/pyhton.html">pyhton</a>
    </section>



    <section>
        <h1>GitHub Repos</h1>
            <a href="https://github.com/1007530194">@1007530194</a> on GitHub
    </section>

</aside>    </div>
</div>
<footer role="contentinfo"><p>
        活到老，学到老，玩到老
    <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-132396898-1', 'auto');

    ga('require', 'displayfeatures');
    ga('send', 'pageview');
    </script>
</body>
</html>